<!DOCTYPE html>
<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Daily Admission Status Report - EPMC</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
<script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1e40af", // Deep blue for professional academic feel
              "background-light": "#f8fafc",
              "background-dark": "#0f172a",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.5rem",
            },
          },
        },
      };
      function toggleDarkMode() {
        document.documentElement.classList.toggle('dark');
      }
      function printReport() {
        window.print();
      }
    </script>
<style>
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background-color: white !important;
                color: black !important;
            }
            .report-container {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                max-width: 100% !important;
            }
            table {
                border-collapse: collapse;
                width: 100%;
            }
            th, td {
                border: 1px solid #000 !important;
            }
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
            font-size: 0.875rem;
        }
        th, td {
            border: 1px solid;
            padding: 8px 4px;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200 transition-colors duration-200">
<nav class="no-print bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-6 py-4 flex justify-between items-center sticky top-0 z-10 shadow-sm">
<div class="flex items-center gap-3">
<span class="material-symbols-outlined text-primary text-3xl">school</span>
<div>
<h1 class="text-lg font-bold text-slate-900 dark:text-white leading-tight">Admin Dashboard</h1>
<p class="text-xs text-slate-500 dark:text-slate-400">Admission Control System</p>
</div>
</div>
<div class="flex gap-4">
<button class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" onclick="toggleDarkMode()">
<span class="material-symbols-outlined dark:hidden">dark_mode</span>
<span class="material-symbols-outlined hidden dark:block">light_mode</span>
</button>
<button class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-md hover:bg-blue-700 transition-all font-medium text-sm" onclick="printReport()">
<span class="material-symbols-outlined text-sm">print</span> Print Report
            </button>
<button id="export-xls" type="button" class="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 transition-all font-medium text-sm">
<span class="material-symbols-outlined text-sm">description</span> Export to Excel
</button>
</div>
</nav>
<main class="max-w-[1200px] mx-auto p-4 md:p-8">
<div class="report-container bg-white dark:bg-slate-900 p-8 shadow-xl border border-slate-200 dark:border-slate-800 rounded-xl">
<header class="text-center mb-8 border-b-2 border-primary pb-6">
<h2 class="text-2xl md:text-3xl font-extrabold text-primary uppercase tracking-tight">Er. Perumal Manimekalai College of Engineering</h2>
<h3 class="text-xl font-semibold text-slate-700 dark:text-slate-300 mt-2">Daily Admission Status - 2025-2026</h3>
<div class="flex justify-between items-end mt-6">
<div class="text-left">
<span class="bg-primary text-white px-4 py-1 rounded text-sm font-bold uppercase tracking-wider">B.E - First Year</span>
</div>
<div class="text-right">
          <form id="report-form" class="flex items-center gap-3" onsubmit="return false;">
            <label class="text-sm text-slate-500">Report Date</label>
            <input id="report-date" type="date" name="date" class="border px-2 py-1 rounded bg-white text-sm" />
            <button id="load-report" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Load</button>
          </form>
          <p class="text-sm font-semibold text-slate-600 dark:text-slate-400 mt-2">Selected: <span id="selected-date-display" class="text-slate-900 dark:text-white ml-2 border-b border-slate-400"></span></p>
</div>
</div>
</header>
    <div class="table-container">
<table class="border-slate-300 dark:border-slate-700">
<thead class="bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-300 uppercase text-[11px] font-bold">
<tr>
<th class="w-10" rowspan="3">S.No</th>
<th class="w-20" rowspan="3">Dept</th>
<th class="py-2" colspan="2">Actual No of Seats</th>
<th colspan="3">Admitted Upto<br/><span class="selected-date-hdr"></span></th>
<th colspan="3">Total Admitted As On<br/><span class="selected-date-hdr"></span></th>
<th colspan="2">Vacancy</th>
</tr>
<tr>
<th class="w-16">MQ</th>
<th class="w-16">GQ</th>
<th class="w-16">MQ</th>
<th class="w-16">GQ</th>
<th class="w-16">GQ(S)</th>
<th class="w-16">MQ</th>
<th class="w-16">GQ</th>
<th class="w-16">GQ(S)</th>
<th class="w-16">MQ</th>
<th class="w-16">GQ</th>
</tr>
</thead>
<tbody class="divide-y divide-slate-200 dark:divide-slate-800 text-slate-700 dark:text-slate-300">
            <!-- Rows will be rendered client-side -->
            <tbody id="report-rows" class="divide-y divide-slate-200 dark:divide-slate-800 text-slate-700 dark:text-slate-300"></tbody>
</tbody>
<tfoot id="report-footer" class="bg-slate-100 dark:bg-slate-800 font-bold text-slate-900 dark:text-white"></tfoot>
</table>
</div>
<div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
<div class="space-y-3">
  <div class="flex items-center justify-between p-3 border border-slate-200 dark:border-slate-800 rounded-lg">
    <div>
      <div class="text-sm font-medium">MQ - TOTAL ADMITTED ON <span id="card-mq-date" class="ml-1 selected-date-hdr"></span></div>
    </div>
    <span id="card-mq-total" class="text-lg font-bold text-primary">0</span>
  </div>
  <div class="flex items-center justify-between p-3 border border-slate-200 dark:border-slate-800 rounded-lg">
    <div>
      <div class="text-sm font-medium">GQ - TOTAL ADMITTED ON <span id="card-gq-date" class="ml-1 selected-date-hdr"></span></div>
    </div>
    <span id="card-gq-total" class="text-lg font-bold text-primary">0</span>
  </div>
  <div class="flex items-center justify-between p-3 border border-slate-200 dark:border-slate-800 rounded-lg">
    <div>
      <div class="text-sm font-medium">GQ(S) - TOTAL ADMITTED ON <span id="card-gqs-date" class="ml-1 selected-date-hdr"></span></div>
    </div>
    <span id="card-gqs-total" class="text-lg font-bold text-primary">0</span>
  </div>
</div>
<div class="flex flex-col justify-center items-center bg-slate-50 dark:bg-slate-800/50 rounded-lg p-6 border-2 border-dashed border-slate-300 dark:border-slate-700">
  <p id="status-reference-title" class="text-slate-500 dark:text-slate-400 uppercase text-xs font-bold tracking-widest mb-1"></p>
  <p id="status-date-display" class="text-2xl font-black text-slate-900 dark:text-white"></p>
</div>
</div>
<div class="mt-12 flex justify-between items-end">
<div class="text-xs text-slate-500 dark:text-slate-400">
<p>Computer Generated Report</p>
<p>Generated on: <span id="current-timestamp"></span></p>
</div>
<div class="text-center w-48 border-t-2 border-slate-300 dark:border-slate-700 pt-2">
<p class="text-xs font-bold uppercase text-slate-700 dark:text-slate-300">Admission Coordinator</p>
</div>
</div>
</div>
</main>
<footer class="no-print mt-12 pb-8 text-center text-slate-500 dark:text-slate-400 text-sm">
<p>Â© 2025 Er. Perumal Manimekalai College of Engineering. All rights reserved.</p>
</footer>
<script>
        document.getElementById('current-timestamp').innerText = new Date().toLocaleString();

        // Client-side rendering: load departments and counselling_records and render the report
        async function fetchJSON(url){
          const r = await fetch(url, { cache: 'no-store' });
          if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
          return r.json();
        }

        function toISODateInput(d){
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth()+1).padStart(2,'0');
          const dd = String(d.getDate()).padStart(2,'0');
          return `${yyyy}-${mm}-${dd}`;
        }

        function formatDisplayDate(d){
          return d.toLocaleDateString();
        }

        function endOfDay(date){ const d = new Date(date); d.setHours(23,59,59,999); return d; }
        function startOfDay(date){ const d = new Date(date); d.setHours(0,0,0,0); return d; }

        async function renderReport(selectedDate){
          const rowsContainer = document.getElementById('report-rows');
          const footer = document.getElementById('report-footer');
          const disp = document.getElementById('selected-date-display');
          disp.innerText = formatDisplayDate(selectedDate);

          // fetch data
          const depts = await fetchJSON('/api/departments');
          const counselling = await fetchJSON('/api/counselling_records');
          const crs = Array.isArray(counselling) ? counselling : (counselling && counselling.items ? counselling.items : []);

          // Filter counselling records that indicate admission completed:
          // completed if allotment_order_number OR consortium_number is present (not null/empty)
          const completed = crs.filter(r => r && (r.allotment_order_number || r.consortium_number));

          const uptoDate = endOfDay(selectedDate);
          const onStart = startOfDay(selectedDate);
          const onEnd = endOfDay(selectedDate);

          let totalMqSeats=0, totalGqSeats=0, totalMqAdmUpto=0, totalGqAdmUpto=0, totalGqsAdmUpto=0, totalMqAdmOn=0, totalGqAdmOn=0, totalGqsAdmOn=0;

          // render rows
          rowsContainer.innerHTML = '';
          depts.forEach((d, idx) => {
            const deptId = d.id;
            const mqSeats = Number(d.mq_seats || d.mq || 0);
            const gqSeats = Number(d.gq_seats || d.gq || (d.seats ? d.seats : 0));
            totalMqSeats += mqSeats;
            totalGqSeats += gqSeats;

            // admitted upto selected date
            const admUptoMQ = completed.filter(r => Number(r.allotted_dept_id) === Number(deptId) && (r.quota_type === 'MQ') && new Date(r.created_at) <= uptoDate).length;
            const admUptoGQ = completed.filter(r => Number(r.allotted_dept_id) === Number(deptId) && (r.quota_type === 'GQ') && new Date(r.created_at) <= uptoDate).length;
            const admUptoGQS = 0; // reserved placeholder

            totalMqAdmUpto += admUptoMQ;
            totalGqAdmUpto += admUptoGQ;
            totalGqsAdmUpto += admUptoGQS;

            // admitted on selected date (records with created_at between start and end of selected date)
            const admOnMQ = completed.filter(r => Number(r.allotted_dept_id) === Number(deptId) && (r.quota_type === 'MQ') && new Date(r.created_at) >= onStart && new Date(r.created_at) <= onEnd).length;
            const admOnGQ = completed.filter(r => Number(r.allotted_dept_id) === Number(deptId) && (r.quota_type === 'GQ') && new Date(r.created_at) >= onStart && new Date(r.created_at) <= onEnd).length;
            const admOnGQS = 0;

            totalMqAdmOn += admOnMQ;
            totalGqAdmOn += admOnGQ;
            totalGqsAdmOn += admOnGQS;

            const vacMq = Math.max(0, mqSeats - admUptoMQ);
            const vacGq = Math.max(0, gqSeats - admUptoGQ);

            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors';
            tr.innerHTML = `
              <td class="font-medium">${idx+1}</td>
              <td class="font-bold text-slate-900 dark:text-white text-left px-4">${escapeHtml(d.dept_code || d.short_name || d.dept_name || '')}</td>
              <td>${mqSeats}</td>
              <td>${gqSeats}</td>
              <td>${admUptoMQ}</td>
              <td>${admUptoGQ}</td>
              <td>${admUptoGQS}</td>
              <td class="bg-slate-50 dark:bg-slate-800/50 font-semibold">${admOnMQ}</td>
              <td class="bg-slate-50 dark:bg-slate-800/50 font-semibold">${admOnGQ}</td>
              <td class="bg-slate-50 dark:bg-slate-800/50 font-semibold">${admOnGQS}</td>
              <td class="text-red-600 dark:text-red-400 font-medium">${vacMq}</td>
              <td class="text-red-600 dark:text-red-400 font-medium">${vacGq}</td>
            `;
            rowsContainer.appendChild(tr);
          });

          // footer totals
          footer.innerHTML = `
            <tr>
              <td class="text-right px-4 py-3 uppercase" colspan="2">Total (${totalMqSeats + totalGqSeats})</td>
              <td>${totalMqSeats}</td>
              <td>${totalGqSeats}</td>
              <td>${totalMqAdmUpto}</td>
              <td>${totalGqAdmUpto}</td>
              <td>${totalGqsAdmUpto}</td>
              <td>${totalMqAdmOn}</td>
              <td>${totalGqAdmOn}</td>
              <td>${totalGqsAdmOn}</td>
              <td class="text-red-600 dark:text-red-400">${Math.max(0, totalMqSeats - totalMqAdmUpto)}</td>
              <td class="text-red-600 dark:text-red-400">${Math.max(0, totalGqSeats - totalGqAdmUpto)}</td>
            </tr>
          `;
          // populate header/date elements and summary cards
          try{
            const dateStr = formatDisplayDate(selectedDate);
            document.querySelectorAll('.selected-date-hdr').forEach(el => el.innerText = dateStr);
            const mqTotalEl = document.getElementById('card-mq-total'); if(mqTotalEl) mqTotalEl.innerText = totalMqAdmOn;
            const gqTotalEl = document.getElementById('card-gq-total'); if(gqTotalEl) gqTotalEl.innerText = totalGqAdmOn;
            const gqsTotalEl = document.getElementById('card-gqs-total'); if(gqsTotalEl) gqsTotalEl.innerText = totalGqsAdmOn;
            const mqDateEl = document.getElementById('card-mq-date'); if(mqDateEl) mqDateEl.innerText = dateStr;
            const gqDateEl = document.getElementById('card-gq-date'); if(gqDateEl) gqDateEl.innerText = dateStr;
            const gqsDateEl = document.getElementById('card-gqs-date'); if(gqsDateEl) gqsDateEl.innerText = dateStr;
            const statusTitle = document.getElementById('status-reference-title'); if(statusTitle) statusTitle.innerText = 'Status Reference Date';
            const statusDate = document.getElementById('status-date-display'); if(statusDate) statusDate.innerText = dateStr;
          }catch(e){ console.warn('populate summary cards error', e); }
        }

        function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>\\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]||c)); }

        document.addEventListener('DOMContentLoaded', () => {
          const dateInput = document.getElementById('report-date');
          const today = new Date();
          dateInput.value = toISODateInput(today);
          const selectedDate = new Date(dateInput.value);

          document.getElementById('load-report').addEventListener('click', async (e) => {
            const val = dateInput.value ? new Date(dateInput.value) : new Date();
            await renderReport(val);
          });

          // Export CSV wiring
          const exportBtn = document.getElementById('export-xls');
          if(exportBtn){
            exportBtn.addEventListener('click', () => {
              try{
                exportReportToCSV();
              }catch(e){ console.error('export error', e); alert('Export failed: ' + (e && e.message ? e.message : e)); }
            });
          }

          // initial render
          renderReport(selectedDate).catch(err => { console.error('renderReport error', err); alert('Error loading report: ' + err.message); });
        });

        // Export table data to CSV (simple, Excel-compatible CSV)
        function exportReportToCSV(){
          const rowsTbody = document.getElementById('report-rows');
          if(!rowsTbody) return alert('Report rows not found');
          const table = document.querySelector('.table-container table');
          if(!table) return alert('Report table not found');

          // build header from second thead row if present, otherwise flatten all th
          let headerCells = [];
          const theadRows = table.querySelectorAll('thead tr');
          if(theadRows && theadRows.length >= 2){
            headerCells = Array.from(theadRows[1].querySelectorAll('th')).map(th => th.innerText.trim());
          } else if(theadRows.length === 1){
            headerCells = Array.from(theadRows[0].querySelectorAll('th')).map(th => th.innerText.trim());
          }

          const csvRows = [];
          if(headerCells.length) csvRows.push(headerCells.join(','));

          const trs = Array.from(rowsTbody.querySelectorAll('tr'));
          trs.forEach(tr => {
            const vals = Array.from(tr.querySelectorAll('td')).map(td => {
              let v = td.innerText || '';
              v = v.replace(/\"/g, '""');
              if(v.indexOf(',') !== -1 || v.indexOf('"') !== -1 || v.indexOf('\n') !== -1) v = '"' + v + '"';
              return v;
            });
            csvRows.push(vals.join(','));
          });

          const csvContent = csvRows.join('\r\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const dateEl = document.getElementById('report-date');
          const datePart = dateEl && dateEl.value ? dateEl.value.replace(/-/g,'') : toISODateInput(new Date());
          const filename = `admissions_report_${datePart}.csv`;

          if(navigator.msSaveBlob){ navigator.msSaveBlob(blob, filename); }
          else {
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(url), 5000);
          }
        }
    </script>

</body></html>