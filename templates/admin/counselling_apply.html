<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Mark Applied for Counselling - PMC</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Lexend', sans-serif; }
    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-white min-h-screen flex flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] px-6 py-3 sticky top-0 z-50">
  <div class="flex items-center gap-4">
    <div class="text-primary">
      <svg fill="none" height="32" viewbox="0 0 48 48" width="32" xmlns="http://www.w3.org/2000/svg">
        <path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path>
      </svg>
    </div>
    <h2 class="text-[#111418] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Er. Perumal Manimekalai College of Engineering</h2>
  </div>
  <div class="flex items-center gap-4">
    <a href="#" onclick="location.href='counselling_list.html'" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">Logout</a>
  </div>
</header>

<div class="flex flex-1">
  <aside class="w-56 border-r border-solid border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#111827] hidden md:flex flex-col">
    <nav class="flex-1 overflow-y-auto px-2 py-6 flex flex-col gap-2">
      <a href="#" data-route="counselling_list" class="flex items-center gap-3 px-4 py-2 text-white bg-primary rounded-lg transition-colors active-nav">
        <span class="material-symbols-outlined text-xl">how_to_vote</span>
        <span class="text-sm font-medium">Counselling</span>
      </a>
    </nav>
  </aside>

  <main class="flex-1 overflow-y-auto">
    <div class="max-w-[900px] mx-auto p-6 flex flex-col gap-6">

      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-extrabold text-primary">Mark Applied for Counselling</h1>
          <p class="text-sm text-primary/80">Record counselling application number and date (step 1)</p>
        </div>
        <div class="hidden md:block">
          <span class="inline-flex items-center px-3 py-1 rounded-full bg-primary/10 text-primary font-medium">Step 1</span>
        </div>
      </div>

      <div class="bg-gradient-to-tr from-white to-sky-50 dark:from-[#071029] dark:to-[#071019] rounded-xl border border-transparent p-1 shadow-2xl">
        <div class="bg-white dark:bg-[#071019] rounded-xl p-6">
          <form id="applyForm" onsubmit="return false;">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Left: Student / step info -->
              <div class="md:col-span-1 flex flex-col gap-4">
                <div class="rounded-lg p-4 bg-gradient-to-r from-primary/10 to-indigo-50 dark:from-primary/20 dark:to-indigo-900 border border-primary/10">
                  <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold">AP</div>
                    <div>
                      <div class="text-sm text-slate-600 dark:text-slate-300">Application</div>
                      <div id="appIdDisplay" class="text-lg font-semibold text-[#0f172a] dark:text-white">#</div>
                      <div id="appCreatedAt" class="text-xs text-slate-500 dark:text-slate-400">Registered: N/A</div>
                      <div id="studentNameDisplay" class="text-sm font-medium mt-2 text-[#111827] dark:text-slate-200">Name: -</div>
                      <div id="studentUniqueDisplay" class="text-xs text-slate-500 mt-1">Unique ID: -</div>
                    </div>
                  </div>
                </div>

                <div class="rounded-lg p-4 bg-white dark:bg-[#08111a] border border-[#e6eefc] dark:border-[#0f172a]">
                  <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Counselling Step 1</h3>
                  <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">Record which counselling streams the student has applied for and capture application numbers, dates and GQ round.</p>
                </div>
              </div>

              <!-- Right: Form controls -->
              <div class="md:col-span-2">
                <div class="flex items-center gap-6 mb-4">
                  <label class="flex items-center gap-3 cursor-pointer p-3 rounded-lg border border-transparent hover:border-primary/20 transition">
                    <input type="checkbox" name="applied_gq" id="applied_gq" class="h-5 w-5 text-green-600 ring-1 ring-green-200 rounded-sm" />
                    <div class="ml-2">
                      <div class="font-semibold text-green-700">General Quota (GQ)</div>
                      <div class="text-xs text-slate-500">Select if applied for General Quota counselling</div>
                    </div>
                  </label>

                  <label class="flex items-center gap-3 cursor-pointer p-3 rounded-lg border border-transparent hover:border-indigo-200 transition">
                    <input type="checkbox" name="applied_mq" id="applied_mq" class="h-5 w-5 text-indigo-600 ring-1 ring-indigo-200 rounded-sm" />
                    <div class="ml-2">
                      <div class="font-semibold text-indigo-700">Management Quota (MQ)</div>
                      <div class="text-xs text-slate-500">Select if applied for Management Quota counselling</div>
                    </div>
                  </label>
                </div>

                <div id="gq_section" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3 opacity-0 max-h-0 overflow-hidden transform transition-all duration-300">
                  <div class="col-span-1">
                    <label class="block text-sm font-medium mb-2 text-green-800">GQ Application Number</label>
                    <input id="gq_application_number" name="gq_application_number" type="text" class="w-full border rounded px-3 py-2 bg-white dark:bg-[#071019] focus:ring-2 focus:ring-green-200" placeholder="Enter GQ application number" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2 text-green-800">GQ Applied Date</label>
                    <input id="gq_applied_at" name="gq_applied_at" type="datetime-local" class="w-full border rounded px-3 py-2 bg-white dark:bg-[#071019] focus:ring-2 focus:ring-green-200" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2 text-green-800">GQ Round</label>
                    <select name="gq_round" id="gq_round" class="w-full border rounded px-3 py-2 bg-white dark:bg-[#071019] focus:ring-2 focus:ring-green-200">
                      <option value="">Select round</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="supplementary">Supplementary</option>
                    </select>
                  </div>
                </div>

                <div id="mq_section" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 opacity-0 max-h-0 overflow-hidden transform transition-all duration-300">
                  <div>
                    <label class="block text-sm font-medium mb-2 text-indigo-800">MQ Consortium Number</label>
                    <input id="mq_consortium_number" name="mq_consortium_number" type="text" class="w-full border rounded px-3 py-2 bg-white dark:bg-[#071019] focus:ring-2 focus:ring-indigo-200" placeholder="Enter MQ consortium number" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2 text-indigo-800">MQ Applied Date</label>
                    <input id="mq_applied_at" name="mq_applied_at" type="datetime-local" class="w-full border rounded px-3 py-2 bg-white dark:bg-[#071019] focus:ring-2 focus:ring-indigo-200" />
                  </div>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                  <button id="saveBtn" type="button" class="px-4 py-2 rounded-md bg-gradient-to-r from-green-600 to-primary text-white font-semibold shadow-lg">Save</button>
                  <a href="counselling_list.html" class="px-4 py-2 rounded-md border border-transparent bg-gray-100 hover:bg-gray-200 text-sm">Cancel</a>
                </div>
                <div id="allotmentPreview" class="mt-6 p-4 rounded-lg border border-dashed border-slate-200 bg-slate-50 dark:bg-[#071019] hidden">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="text-sm font-semibold">Allotment Preview</div>
                      <div id="apv_dept" class="text-sm text-slate-600 mt-1">Dept: -</div>
                      <div id="apv_order" class="text-sm text-slate-600 mt-1">Order: -</div>
                      <div id="apv_cons" class="text-sm text-slate-600 mt-1">Consortium: -</div>
                    </div>
                    <div>
                      <a id="apv_edit" href="#" class="inline-flex items-center gap-2 bg-primary text-white px-3 py-2 rounded-lg">Edit Allotment</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
(() => {
  function toggleSections() {
    const gq = document.getElementById('applied_gq');
    const mq = document.getElementById('applied_mq');
    const gqSection = document.getElementById('gq_section');
    const mqSection = document.getElementById('mq_section');

    if (gq && gq.checked) { gqSection.style.opacity = '1'; gqSection.style.maxHeight = '200px'; gqSection.style.paddingTop = '0.5rem'; }
    else { gqSection.style.opacity = '0'; gqSection.style.maxHeight = '0'; gqSection.style.paddingTop = '0'; }

    if (mq && mq.checked) { mqSection.style.opacity = '1'; mqSection.style.maxHeight = '200px'; mqSection.style.paddingTop = '0.5rem'; }
    else { mqSection.style.opacity = '0'; mqSection.style.maxHeight = '0'; mqSection.style.paddingTop = '0'; }
  }

  function qs(name) { return new URLSearchParams(location.search).get(name); }

  async function fetchAppAndStudent(appId) {
    if (!appId) return {};
    const appsRes = await fetch('/api/_admission_applications').then(r=>r.json()).catch(()=>({ok:false, items:[]}));
    const apps = Array.isArray(appsRes) ? appsRes : (appsRes && appsRes.ok && Array.isArray(appsRes.items) ? appsRes.items : []);
    const app = apps.find(a=>String(a.app_id)===String(appId) || String(a.id)===String(appId));
    let student = null;
    if (app && app.student_id) {
      const studentsRes = await fetch('/api/students').then(r=>r.json()).catch(()=>({ok:false, items:[]}));
      const students = Array.isArray(studentsRes) ? studentsRes : (studentsRes && studentsRes.ok && Array.isArray(studentsRes.items) ? studentsRes.items : []);
      student = students.find(s=>String(s.id)===String(app.student_id));
    }
    return { app, student };
  }

  async function load() {
    const appId = qs('app_id');
    const { app, student } = await fetchAppAndStudent(appId);
    document.getElementById('appIdDisplay').textContent = app ? ('#'+(app.app_id||app.id)) : ('#'+(appId||''));
    document.getElementById('appCreatedAt').textContent = app && app.created_at ? ('Registered: '+new Date(app.created_at).toLocaleString()) : 'Registered: N/A';

    // fill student info (if available: update the heading area)
    if (student) {
      // populate student name and unique id in the left info panel
      const sn = document.getElementById('studentNameDisplay');
      const su = document.getElementById('studentUniqueDisplay');
      if(sn) sn.textContent = 'Name: ' + (student.full_name || student.student_name || '-');
      if(su) su.textContent = 'Unique ID: ' + (student.unique_id || '-');
    }

    // load existing counselling record if present
    const cRes = await fetch('/api/counselling_records?app_id=' + encodeURIComponent(appId)).then(r=>r.json()).catch(()=>({ok:false, items:[]}));
    const c = Array.isArray(cRes) ? cRes[0] : (cRes && cRes.ok && Array.isArray(cRes.items) ? cRes.items[0] : null);

    // load departments map for allotment preview
    const deptsRes = await fetch('/api/departments').then(r=>r.json()).catch(()=>({ok:false, items:[]}));
    const depts = Array.isArray(deptsRes) ? deptsRes : (deptsRes && deptsRes.ok && Array.isArray(deptsRes.items) ? deptsRes.items : []);
    const deptMap = {};
    if(Array.isArray(depts)) depts.forEach(d=>{ if(d && d.id) deptMap[String(d.id)] = d; });

    if (c) {
      document.getElementById('applied_gq').checked = !!c.applied_gq;
      document.getElementById('applied_mq').checked = !!c.applied_mq;
      document.getElementById('gq_application_number').value = c.gq_application_number || c.counselling_application_number || '';
      if (c.gq_applied_at) document.getElementById('gq_applied_at').value = new Date(c.gq_applied_at).toISOString().slice(0,16);
      if (c.gq_round) document.getElementById('gq_round').value = c.gq_round;
      // autofill consortium number in the form: prefer canonical `consortium_number`, fall back to `mq_consortium_number`
      const consVal = (c.consortium_number && String(c.consortium_number).trim()) ? c.consortium_number : (c.mq_consortium_number && String(c.mq_consortium_number).trim() ? c.mq_consortium_number : '');
      if(consVal) document.getElementById('mq_consortium_number').value = consVal;
      if (c.mq_applied_at) document.getElementById('mq_applied_at').value = new Date(c.mq_applied_at).toISOString().slice(0,16);
    }

    function updateAllotmentPreview() {
      const preview = document.getElementById('allotmentPreview');
      const apvDept = document.getElementById('apv_dept');
      const apvOrder = document.getElementById('apv_order');
      const apvCons = document.getElementById('apv_cons');
      const apvEdit = document.getElementById('apv_edit');
      const gqChecked = document.getElementById('applied_gq').checked;
      if(!gqChecked) { preview.classList.add('hidden'); return; }
      if(!c) { preview.classList.add('hidden'); return; }
      // show preview when GQ selected â€” prefer department name, order number, consortium
      const deptName = c.allotted_dept_id ? (deptMap[String(c.allotted_dept_id)] && (deptMap[String(c.allotted_dept_id)].dept_name || deptMap[String(c.allotted_dept_id)].dept_code)) : '-';
      apvDept.textContent = 'Dept: ' + (deptName || '-');
      apvOrder.textContent = 'Order: ' + (c.allotment_order_number || (c.allotment_order_url ? 'Uploaded PDF' : '-') );
      apvCons.textContent = 'Consortium: ' + (c.consortium_number || ' - ');
      apvEdit.href = 'counselling_form.html?app_id=' + encodeURIComponent(appId);
      preview.classList.remove('hidden');
    }

    // run once to set preview if relevant
    updateAllotmentPreview();

    toggleSections();
    document.getElementById('applied_gq').addEventListener('change', ()=>{ toggleSections(); updateAllotmentPreview(); });
    document.getElementById('applied_mq').addEventListener('change', toggleSections);

    document.getElementById('saveBtn').addEventListener('click', async () => {
      const payload = {
        app_id: appId,
        applied_gq: !!document.getElementById('applied_gq').checked,
        applied_mq: !!document.getElementById('applied_mq').checked,
        gq_application_number: document.getElementById('gq_application_number').value || null,
        gq_applied_at: document.getElementById('gq_applied_at').value || null,
        gq_round: document.getElementById('gq_round').value || null,
        mq_consortium_number: document.getElementById('mq_consortium_number').value || null,
        mq_applied_at: document.getElementById('mq_applied_at').value || null
      };
      try {
        const r = await fetch('/api/counselling_records', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        const j = await r.json();
        if (j && j.ok) { alert('Saved'); location.href = 'counselling_list.html'; }
        else { alert('Error saving: ' + (j && j.error || JSON.stringify(j))); }
      } catch (err) { console.error(err); alert('Error saving'); }
    });
  }

  document.addEventListener('DOMContentLoaded', load);
})();
</script>
</body>
</html>
