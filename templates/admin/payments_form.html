<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Payment Form - PMC Engineering</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>
        body {
            font-family: 'Lexend', sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-white min-h-screen flex flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] px-6 py-3 sticky top-0 z-50">
<div class="flex items-center gap-4">
<div class="text-primary">
<svg fill="none" height="32" viewbox="0 0 48 48" width="32" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-[#111418] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Er. Perumal Manimekalai College of Engineering</h2>
</div>
<div class="flex items-center gap-4">
<a href="{{ url_for('auth.logout') }}" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">Logout</a>
</div>
</header>

<main class="flex-1 overflow-y-auto">
<div class="max-w-4xl mx-auto p-6 flex flex-col gap-6">
<a href="payments_list.html" class="flex items-center gap-2 text-primary hover:text-primary/80 font-semibold mb-4">
<span class="material-symbols-outlined">arrow_back</span>
Back to Payments
</a>

<div id="flashContainer"></div>

<!-- Page Header -->
<div class="flex flex-wrap justify-between items-end gap-3">
<div class="flex min-w-72 flex-col gap-1">
<p class="text-[#111418] dark:text-white text-3xl font-black leading-tight tracking-[-0.033em]">Initial Payment</p>
<p class="text-[#617589] dark:text-[#a0aec0] text-base font-normal leading-normal">Collect initial payment for admission</p>
</div>
</div>

<!-- Student Information Card -->
<div class="bg-white dark:bg-[#1a202c] rounded-xl border border-[#e5e7eb] dark:border-[#2d3748] p-6">
<h3 class="text-lg font-bold text-[#111418] dark:text-white mb-4">Student Information</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
            <label class="block text-sm font-semibold text-gray-600 mb-1">Student Name</label>
            <p id="studentName" class="text-lg font-bold text-gray-800">-</p>
        </div>
        <div>
            <label class="block text-sm font-semibold text-gray-600 mb-1">Unique ID</label>
            <p id="studentUnique" class="text-lg font-bold text-blue-600">-</p>
        </div>
        <div>
            <label class="block text-sm font-semibold text-gray-600 mb-1">Registration ID</label>
            <p id="registrationId" class="text-lg font-bold text-green-600">-</p>
        </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 pt-4 border-t border-gray-200">
        <div>
            <label class="block text-sm font-semibold text-gray-600 mb-1">Allotted Department</label>
            <p id="deptName" class="text-lg font-bold text-gray-800">-</p>
        </div>
        <div>
            <label class="block text-sm font-semibold text-gray-600 mb-1">Allotted Quota</label>
            <p id="quotaType" class="text-sm text-gray-500">-</p>
        </div>
    </div>
</div>

<!-- Payment Form Card -->
<div class="bg-white dark:bg-[#1a202c] rounded-xl border border-[#e5e7eb] dark:border-[#2d3748] p-6">
<h3 class="text-lg font-bold text-[#111418] dark:text-white mb-6">Payment Details</h3>

<form id="paymentForm" class="space-y-6">
    <div>
        <label for="bill_no" class="block text-sm font-semibold text-gray-700 mb-2">
            <span class="flex items-center gap-2">
                <span class="material-symbols-outlined text-lg">receipt_long</span>
                Bill Number
            </span>
        </label>
        <input type="text" id="bill_no" name="bill_no" placeholder="e.g., BILL-001" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg" required />
        <p class="text-xs text-gray-500 mt-1">Unique bill/invoice number for this payment</p>
    </div>

    <div>
        <label for="mode_of_payment" class="block text-sm font-semibold text-gray-700 mb-2">
            <span class="flex items-center gap-2"><span class="material-symbols-outlined text-lg">account_balance_wallet</span> Mode of Payment</span>
        </label>
        <select id="mode_of_payment" name="mode_of_payment" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg" required>
            <option value="">-- Select Mode of Payment --</option>
            <option value="Cash">Cash</option>
            <option value="Card">Card (Debit/Credit)</option>
            <option value="Cheque">Cheque</option>
            <option value="Bank Transfer">Bank Transfer</option>
            <option value="UPI">UPI</option>
        </select>
        <p class="text-xs text-gray-500 mt-1">Select the method used for payment</p>
    </div>

    <div>
        <label for="amount" class="block text-sm font-semibold text-gray-700 mb-2">
            <span class="flex items-center gap-2"><span class="material-symbols-outlined text-lg">currency_rupee</span> Amount (â‚¹)</span>
        </label>
        <input type="number" id="amount" name="amount" step="0.01" min="0" placeholder="e.g., 50000" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg" required />
        <p class="text-xs text-gray-500 mt-1">Enter the payment amount in rupees</p>
    </div>

    <div id="upi-row" style="display:none;">
        <label for="upi_id" class="block text-sm font-semibold text-gray-700 mb-2">UPI ID (e.g., name@bank)</label>
        <input type="text" id="upi_id" name="upi_id" placeholder="e.g., name@upi" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg" />
    </div>

    <div class="flex gap-4 pt-4 border-t border-gray-200">
        <button type="submit" class="flex items-center gap-2 bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-lg">
            <span class="material-symbols-outlined">check_circle</span>
            Save Payment
        </button>
        <a href="payments_list.html" class="flex items-center gap-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg">
            <span class="material-symbols-outlined">close</span>
            Cancel
        </a>
    </div>
</form>
</div>
</div>
</main>

<script>
function $(id){ return document.getElementById(id); }
function showFlash(msg, type='error'){
    const fc = document.getElementById('flashContainer'); if(!fc) return; fc.innerHTML = `<div class="bg-${type==='success'?'green':'red'}-50 border border-${type==='success'?'green':'red'}-200 text-${type==='success'?'green':'red'}-800 px-4 py-3 rounded-lg">${msg}</div>`;
}

function debounce(fn, delay){ let t; return function(){ const args=arguments; const ctx=this; clearTimeout(t); t=setTimeout(function(){ fn.apply(ctx, args); }, delay); }; }

async function fetchJson(url){ const r = await fetch(url); if(!r.ok) throw new Error('fetch failed '+url); return r.json(); }

function getQueryParam(name){ const params = new URLSearchParams(window.location.search); return params.get(name); }

async function loadPaymentForm(){
    const appId = getQueryParam('app_id');
    if(!appId){ showFlash('app_id query param required'); return; }

    try{
        // fetch admission_application by app_id first, fall back to diagnostics and counselling_records
        let app = null;
        try{
            const appRes = await fetchJson('/api/admission_applications?app_id='+encodeURIComponent(appId));
            if(appRes && appRes.ok && appRes.item) app = appRes.item;
            else if(appRes && appRes.item) app = appRes.item;
        }catch(e){ /* not found or error, we'll fallback */ }

        if(!app){
            // try diagnostic list as a fallback
            let apps = await fetchJson('/api/_admission_applications');
            if(!Array.isArray(apps) && apps && Array.isArray(apps.items)) apps = apps.items;
            if(!Array.isArray(apps)) apps = [];
            app = apps.find(a=>String(a.app_id)===String(appId));
        }
        // If admission application row not found, try to recover from counselling_records
        if(!app){
            try{
                let crs = await fetchJson('/api/counselling_records');
                if(!Array.isArray(crs) && crs && Array.isArray(crs.data)) crs = crs.data;
                if(!Array.isArray(crs)) crs = [];
                const cr = crs.find(c=>String(c.app_id)===String(appId));
                if(cr){
                    app = {
                        app_id: Number(cr.app_id),
                        student_id: cr.student_id || null,
                        preferred_dept_id: cr.allotted_dept_id || null,
                        quota_type: cr.quota_type || null,
                        registration_id: null
                    };
                }
            }catch(e){ console.warn('counselling_records fetch failed', e); }
        }

        if(!app){ showFlash('Admission application not found'); return; }

        let students = await fetchJson('/api/students');
        if(!Array.isArray(students) && students && Array.isArray(students.data)) students = students.data;
        if(!Array.isArray(students)) students = [];
        const stud = students.find(s=>String(s.id)===String(app.student_id));

        let deps = await fetchJson('/api/departments');
        if(!Array.isArray(deps) && deps && Array.isArray(deps.data)) deps = deps.data;
        if(!Array.isArray(deps)) deps = [];
        const deptMap = {}; deps.forEach(d=>{ deptMap[String(d.id)] = d.dept_name || d.name; });

        $('studentName').textContent = stud ? (stud.full_name || stud.student_name || '') : '-';
        $('studentUnique').textContent = stud ? (stud.unique_id || '') : '-';
        $('registrationId').textContent = app.registration_id || '-';
        $('deptName').textContent = (app.preferred_dept_id ? (deptMap[String(app.preferred_dept_id)] || ('Dept #'+app.preferred_dept_id)) : '-');
        $('quotaType').textContent = app.quota_type || '-';

        // wire UPI visibility
        $('mode_of_payment').addEventListener('change', function(e){ const upiRow = $('upi-row'); if(this.value==='UPI'){ upiRow.style.display='block'; $('upi_id').required = true; } else { upiRow.style.display='none'; $('upi_id').required = false; } });

        // submit handler
        $('paymentForm').addEventListener('submit', async function(ev){ ev.preventDefault();
            const bill_no = $('bill_no').value.trim(); const mode_of_payment = $('mode_of_payment').value; const amount = $('amount').value; const upi_id = $('upi_id').value.trim();
            if(!bill_no || !mode_of_payment || !amount) { showFlash('Please fill required fields'); return; }
            const payload = { app_id: Number(appId), bill_no, mode_of_payment, amount: Number(amount) };
            if(mode_of_payment==='UPI' && upi_id) payload.upi_id = upi_id;
            try{
                const r = await fetch('/api/payments', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
                const j = await r.json();
                if(!r.ok) { showFlash(j && j.error ? j.error : 'Failed to create payment'); return; }
                showFlash('Payment saved', 'success');
                setTimeout(()=> location.href = 'payments_list.html', 800);
            }catch(e){ console.error(e); showFlash('Request failed'); }
        });

    }catch(e){ console.error(e); showFlash('Failed to load form'); }
}

document.addEventListener('DOMContentLoaded', ()=>{ loadPaymentForm(); });
</script>
</body>
</html>
