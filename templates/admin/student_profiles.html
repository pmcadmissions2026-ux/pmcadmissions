<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Student Profiles - PMC Engineering</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<style>body{font-family:'Lexend',sans-serif}.material-symbols-outlined{font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24}</style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-white min-h-screen flex flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] px-6 py-3 sticky top-0 z-50">
<div class="flex items-center gap-4">
<div class="text-primary">
<svg fill="none" height="32" viewbox="0 0 48 48" width="32" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-[#111418] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Er. Perumal Manimekalai College of Engineering</h2>
</div>
<div class="flex items-center gap-4">
<button id="exportBtn" onclick="openExportModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
  <span class="material-symbols-outlined text-sm">file_download</span>
  Export to Excel
</button>
<a href="#" data-route="super_admin_dashboard" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Back to Dashboard</a>
<a href="{{ url_for('auth.logout') }}" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">Logout</a>
</div>
</header>

<main class="flex-1 overflow-y-auto">
<div class="max-w-[1900px] mx-auto p-6 flex flex-col gap-6">

<!-- Export modal -->
<div id="exportModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
  <div class="bg-white dark:bg-[#0f172a] rounded-lg w-[720px] max-w-full p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-bold">Select fields to export</h3>
      <button onclick="closeExportModal()" class="text-slate-500 hover:text-slate-800">✕</button>
    </div>
    <div class="mb-3 text-sm text-slate-600 dark:text-slate-300">Choose columns for the <strong>Students</strong> sheet. Use <em>Select all</em> or pick manually.</div>
    <div class="flex items-center gap-3 mb-4">
      <button onclick="selectAllFields(true)" class="px-3 py-1 bg-blue-600 text-white rounded">Select all</button>
      <button onclick="selectAllFields(false)" class="px-3 py-1 bg-gray-200 dark:bg-[#1f2937] text-sm">Deselect all</button>
      <span class="text-xs text-slate-500 ml-3">Selected: <span id="selectedCount">0</span></span>
    </div>
    <div class="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto border rounded p-3 bg-slate-50 dark:bg-[#071127]">
      {% for field in export_fields %}
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" class="export-field-checkbox" value="{{ field }}" onchange="updateSelectedCount()" />
        <span>{{ field }}</span>
      </label>
      {% endfor %}
    </div>
    <div class="mt-4 flex justify-end gap-3">
      <button onclick="closeExportModal()" class="px-4 py-2 bg-gray-200 dark:bg-[#1f2937] rounded">Cancel</button>
      <button onclick="submitExport()" class="px-4 py-2 bg-green-600 text-white rounded">Export</button>
    </div>
  </div>
</div>
<!-- Header Section -->
<div class="bg-gradient-to-r from-blue-600 to-blue-800 dark:from-blue-900 dark:to-blue-950 rounded-xl p-6 text-white shadow-lg">
<div class="flex flex-wrap justify-between items-start gap-4">
<div class="flex flex-col gap-2">
<p class="text-4xl font-black leading-tight">Student Profiles</p>
<p class="text-blue-100 text-base font-normal">Complete student data from all tables in comprehensive table format</p>
</div>
<div class="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
<p class="text-sm text-blue-50">Total Records: <span class="font-bold text-xl">{{ students|length }}</span></p>
</div>
</div>
</div>

<!-- Search and Filter Section -->
<div class="bg-white dark:bg-[#1a202c] rounded-xl border border-[#e5e7eb] dark:border-[#2d3748] p-4 shadow-sm">
<div class="flex flex-wrap gap-3 items-center">
<div class="flex-1 min-w-xs">
<input type="text" id="studentSearch" placeholder="Search by name, ID, email or phone..." class="w-full px-4 py-2 border border-[#e5e7eb] dark:border-[#4a5568] rounded-lg bg-white dark:bg-[#2d3748] text-[#111418] dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
</div>
<button onclick="document.getElementById('studentSearch').value = ''; location.reload();" class="px-4 py-2 bg-gray-200 dark:bg-[#2d3748] text-gray-800 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-[#4a5568] transition-colors font-medium text-sm">
<span class="material-symbols-outlined inline text-sm mr-1">refresh</span>Reset
</button>
</div>
</div>

<div class="bg-white dark:bg-[#1a202c] rounded-xl border border-[#e5e7eb] dark:border-[#2d3748] overflow-hidden shadow-md">
<div class="overflow-x-auto">
<table class="w-full text-left border-collapse text-xs">
<thead>
<tr class="bg-gradient-to-r from-[#f3f4f6] to-[#e5e7eb] dark:from-[#2d3748] dark:to-[#1a202c] border-b-2 border-[#d1d5db] dark:border-[#4a5568]">
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider sticky left-0 bg-gradient-to-r from-[#f3f4f6] to-[#e5e7eb] dark:from-[#2d3748] dark:to-[#1a202c] z-10">Name</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">ID</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Email</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Phone</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Gender</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">DOB</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Community</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Religion</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Status</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">School</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">HSC %</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Cutoff</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">TNEA Elig.</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">TNEA Avg</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Preferred</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Quota</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Allotted</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Order</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Cons. #</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Counsel Status</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Payment</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Documents</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Action</th>
</tr>
</thead>
<tbody class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]">
{% if students %}
{% for data in students %}
<tr class="hover:bg-blue-50 dark:hover:bg-[#2d3748] transition-colors duration-150 border-l-4 border-l-transparent hover:border-l-blue-500">
<td class="px-4 py-3 text-xs font-semibold text-[#111418] dark:text-white sticky left-0 bg-white dark:bg-[#1a202c] hover:bg-blue-50 dark:hover:bg-[#2d3748]">
<div class="flex items-center gap-2">
<div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold text-xs">
{{ (data.student.full_name or data.student.name or 'N')[0]|upper }}
</div>
{{ data.student.full_name or data.student.name or 'N/A' }}
</div>
</td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] font-mono bg-[#f9fafb] dark:bg-[#0f172a]">{{ data.student.unique_id or 'N/A' }}</td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] truncate">{{ data.student.email or 'N/A' }}</td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1]">{{ data.student.phone or 'N/A' }}</td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] capitalize">{{ data.student.gender or 'N/A' }}</td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1]">{{ data.student.dob or 'N/A' }}</td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1]">{{ data.student.community or 'N/A' }}</td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1]">{{ data.student.religion or 'N/A' }}</td>
<td class="px-4 py-3"><span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">{{ data.student.status or 'N/A' }}</span></td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] truncate">{{ data.academic.school_name or 'N/A' }}</td>
<td class="px-4 py-3 text-xs font-semibold text-[#1f2937] dark:text-[#f0f9ff] bg-amber-50 dark:bg-amber-900/20">{{ data.student.plus2_percentage or 'N/A' }}</td>
<td class="px-4 py-3 text-xs font-bold text-[#7c2d12] dark:text-[#fed7aa] bg-orange-100 dark:bg-orange-900/30 rounded px-2">{{ data.academic.cutoff or 'N/A' }}</td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1]">{{ data.academic.tnea_eligible or 'N/A' }}</td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1]">{{ data.academic.tnea_average or 'N/A' }}</td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] truncate">{% if data.admissions %}{% for adm in data.admissions %}<span class="inline-block px-2 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded mr-1">{{ adm.preferred_dept_name or 'N/A' }}</span>{% endfor %}{% else %}N/A{% endif %}</td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1]">{% if data.counselling %}{% for counsel in data.counselling %}<span class="inline-block px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded text-xs font-medium mr-1">{{ counsel.quota_type or 'N/A' }}</span>{% endfor %}{% else %}N/A{% endif %}</td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] truncate">{% if data.counselling %}{% for counsel in data.counselling %}{{ counsel.dept_name or 'N/A' }}{% if not loop.last %}, {% endif %}{% endfor %}{% else %}N/A{% endif %}</td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] font-mono">{% if data.counselling %}{% for counsel in data.counselling %}{{ counsel.allotment_order_number or 'N/A' }}{% if not loop.last %}, {% endif %}{% endfor %}{% else %}N/A{% endif %}</td>
<td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] font-mono">{% if data.counselling %}{% for counsel in data.counselling %}{{ counsel.consortium_number or 'N/A' }}{% if not loop.last %}, {% endif %}{% endfor %}{% else %}N/A{% endif %}</td>
<td class="px-4 py-3">{% if data.counselling %}{% for counsel in data.counselling %}<span class="inline-block px-2 py-1 rounded-full text-xs font-semibold {% if counsel.status == 'Registered' %}bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300{% elif counsel.status == 'Allotted' %}bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300{% else %}bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300{% endif %} mr-1">{{ counsel.status or 'N/A' }}</span>{% endfor %}{% else %}<span class="text-xs text-slate-400">N/A</span>{% endif %}</td>
<td class="px-4 py-3"><span class="px-3 py-1 rounded-lg text-xs font-bold text-green-700 dark:text-green-300 bg-green-100 dark:bg-green-900/30">{% if data.payments %}{% for pay in data.payments %}₹{{ pay.amount or '0' }}{% if not loop.last %}, {% endif %}{% endfor %}{% else %}-{% endif %}</span></td>
<td class="px-4 py-3 text-xs">
{% if data.applications %}
  {% for app in data.applications %}
    {% set docs = data.documents_by_app.get(app.app_id, {}) %}
    <div class="mb-2">
      <div class="font-semibold text-xs mb-1 text-[#1f2937] dark:text-[#e2e8f0]">App #{{ app.app_id }}</div>
      <div class="flex flex-wrap gap-1">
        <!-- 10th Mark Sheet -->
        {% if docs.get('10th_Mark_Sheet') %}
          {% set doc = docs['10th_Mark_Sheet'] %}
          <a href="{{ doc.document_url }}" target="_blank" rel="noopener noreferrer" title="View 10th Mark Sheet" class="inline-flex items-center gap-1 bg-blue-500 text-white text-xs font-bold py-1 px-2 rounded hover:bg-blue-600 shadow-sm hover:shadow-md transition-all">
            <span class="material-symbols-outlined text-xs">visibility</span>
          </a>
        {% else %}
          <span class="text-xs text-slate-300 px-2">-</span>
        {% endif %}
        
        <!-- 12th Mark Sheet -->
        {% if docs.get('12th_Mark_Sheet') %}
          {% set doc = docs['12th_Mark_Sheet'] %}
          <a href="{{ doc.document_url }}" target="_blank" rel="noopener noreferrer" title="View 12th Mark Sheet" class="inline-flex items-center gap-1 bg-cyan-500 text-white text-xs font-bold py-1 px-2 rounded hover:bg-cyan-600 shadow-sm hover:shadow-md transition-all">
            <span class="material-symbols-outlined text-xs">visibility</span>
          </a>
        {% else %}
          <span class="text-xs text-slate-300 px-2">-</span>
        {% endif %}
        
        <!-- Community Certificate -->
        {% if docs.get('Community_Certificate') %}
          {% set doc = docs['Community_Certificate'] %}
          <a href="{{ doc.document_url }}" target="_blank" rel="noopener noreferrer" title="View Community Certificate" class="inline-flex items-center gap-1 bg-teal-500 text-white text-xs font-bold py-1 px-2 rounded hover:bg-teal-600 shadow-sm hover:shadow-md transition-all">
            <span class="material-symbols-outlined text-xs">visibility</span>
          </a>
        {% else %}
          <span class="text-xs text-slate-300 px-2">-</span>
        {% endif %}
        
        <!-- Transfer Certificate -->
        {% if docs.get('Transfer_Certificate') %}
          {% set doc = docs['Transfer_Certificate'] %}
          <a href="{{ doc.document_url }}" target="_blank" rel="noopener noreferrer" title="View Transfer Certificate" class="inline-flex items-center gap-1 bg-indigo-500 text-white text-xs font-bold py-1 px-2 rounded hover:bg-indigo-600 shadow-sm hover:shadow-md transition-all">
            <span class="material-symbols-outlined text-xs">visibility</span>
          </a>
        {% else %}
          <span class="text-xs text-slate-300 px-2">-</span>
        {% endif %}
        
        <!-- FG Certificate -->
        {% if docs.get('FG_Certificate') %}
          {% set doc = docs['FG_Certificate'] %}
          <a href="{{ doc.document_url }}" target="_blank" rel="noopener noreferrer" title="View FG Certificate" class="inline-flex items-center gap-1 bg-emerald-500 text-white text-xs font-bold py-1 px-2 rounded hover:bg-emerald-600 shadow-sm hover:shadow-md transition-all">
            <span class="material-symbols-outlined text-xs">visibility</span>
          </a>
        {% else %}
          <span class="text-xs text-slate-300 px-2">-</span>
        {% endif %}
        
        <!-- Passport Photo -->
        {% if docs.get('Passport_Photo') %}
          {% set doc = docs['Passport_Photo'] %}
          <a href="{{ doc.document_url }}" target="_blank" rel="noopener noreferrer" title="View Passport Photo" class="inline-flex items-center gap-1 bg-purple-500 text-white text-xs font-bold py-1 px-2 rounded hover:bg-purple-600 shadow-sm hover:shadow-md transition-all">
            <span class="material-symbols-outlined text-xs">visibility</span>
          </a>
        {% else %}
          <span class="text-xs text-slate-300 px-2">-</span>
        {% endif %}
        
        <!-- Allotment Order (from counselling) -->
        {% set allotment = data.counselling | selectattr('app_id', 'equalto', app.app_id) | first if data.counselling else None %}
        {% if allotment and allotment.allotment_order_url %}
          <a href="{{ allotment.allotment_order_url }}" target="_blank" rel="noopener noreferrer" title="View Allotment Order" class="inline-flex items-center gap-1 bg-orange-500 text-white text-xs font-bold py-1 px-2 rounded hover:bg-orange-600 shadow-sm hover:shadow-md transition-all">
            <span class="material-symbols-outlined text-xs">visibility</span>
          </a>
        {% else %}
          <span class="text-xs text-slate-300 px-2">-</span>
        {% endif %}
      </div>
    </div>
  {% endfor %}
{% else %}
  <span class="text-xs text-slate-400">No docs</span>
{% endif %}
</td>
<td class="px-4 py-3">
<a href="#" data-action="student_profile" data-student-id="{{ data.student.id }}" class="inline-flex items-center gap-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-xs font-bold py-2 px-3 rounded-lg transition-all shadow-md hover:shadow-lg transform hover:scale-105">
<span class="material-symbols-outlined text-sm">visibility</span>
View
</a>
</td>
</tr>
{% endfor %}
{% else %}
<tr>
<td colspan="23" class="px-6 py-12 text-center">
<div class="flex flex-col items-center gap-3">
<span class="material-symbols-outlined text-6xl text-slate-300">person_off</span>
<p class="text-base font-semibold text-slate-600 dark:text-slate-400">No students found</p>
</div>
</td>
</tr>
{% endif %}
</tbody>
</table>
</div>
</div>

</div>
</main>

<script>
// Search functionality
const searchInput = document.getElementById('studentSearch');
if (searchInput) {
  searchInput.addEventListener('keyup', function(e) {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
      if (row.textContent.toLowerCase().includes(searchTerm)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
    
    // Update record count
    const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
    const recordCount = document.querySelector('.bg-white\\/20');
    if (recordCount) {
      recordCount.innerHTML = `<p class="text-sm text-blue-50">Showing: <span class="font-bold text-xl">${visibleRows.length}</span></p>`;
    }
  });
}

// Auto-adjust table columns width on window resize
window.addEventListener('resize', function() {
  const table = document.querySelector('table');
  if (table) {
    table.style.minWidth = Math.max(1200, window.innerWidth - 40) + 'px';
  }
});

// Export modal JS
function openExportModal() {
  const modal = document.getElementById('exportModal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    // default select all
    selectAllFields(true);
    updateSelectedCount();
  }
}

function closeExportModal() {
  const modal = document.getElementById('exportModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
}

function selectAllFields(yes) {
  const boxes = document.querySelectorAll('.export-field-checkbox');
  boxes.forEach(b => b.checked = !!yes);
  updateSelectedCount();
}

function updateSelectedCount() {
  const boxes = Array.from(document.querySelectorAll('.export-field-checkbox'));
  const count = boxes.filter(b => b.checked).length;
  const el = document.getElementById('selectedCount');
  if (el) el.textContent = count;
}

function submitExport() {
  const boxes = Array.from(document.querySelectorAll('.export-field-checkbox'));
  const selected = boxes.filter(b => b.checked).map(b => b.value);
  // Build query param
  const params = new URLSearchParams();
  if (selected.length) params.set('fields', selected.join(','));
  const url = '{{ url_for('admin.student_profiles_export_excel') }}' + (params.toString() ? ('?' + params.toString()) : '');
  // Navigate to export URL
  window.location.href = url;
}
</script>
</body>
</html>
