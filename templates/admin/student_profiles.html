<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Student Profiles - PMC Engineering</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<style>body{font-family:'Lexend',sans-serif}.material-symbols-outlined{font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24}</style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-white min-h-screen flex flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] px-6 py-3 sticky top-0 z-50">
<div class="flex items-center gap-4">
<div class="text-primary">
<svg fill="none" height="32" viewbox="0 0 48 48" width="32" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-[#111418] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Er. Perumal Manimekalai College of Engineering</h2>
</div>
<div class="flex items-center gap-4">
<button id="exportBtn" onclick="openExportModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
  <span class="material-symbols-outlined text-sm">file_download</span>
  Export to Excel
</button>
<a href="#" data-route="super_admin_dashboard" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Back to Dashboard</a>
<a href="#" id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">Logout</a>
</div>
</header>

<main class="flex-1 overflow-y-auto">
<div class="max-w-[1900px] mx-auto p-6 flex flex-col gap-6">

<!-- Export modal -->
<div id="exportModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
  <div class="bg-white dark:bg-[#0f172a] rounded-lg w-[720px] max-w-full p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-bold">Select fields to export</h3>
      <button onclick="closeExportModal()" class="text-slate-500 hover:text-slate-800">✕</button>
    </div>
    <div class="mb-3 text-sm text-slate-600 dark:text-slate-300">Choose columns for the <strong>Students</strong> sheet. Use <em>Select all</em> or pick manually.</div>
    <div class="flex items-center gap-3 mb-4">
      <button onclick="selectAllFields(true)" class="px-3 py-1 bg-blue-600 text-white rounded">Select all</button>
      <button onclick="selectAllFields(false)" class="px-3 py-1 bg-gray-200 dark:bg-[#1f2937] text-sm">Deselect all</button>
      <span class="text-xs text-slate-500 ml-3">Selected: <span id="selectedCount">0</span></span>
    </div>
    <div id="exportFieldsContainer" class="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto border rounded p-3 bg-slate-50 dark:bg-[#071127]"></div>
    <div class="mt-4 flex justify-end gap-3">
      <button onclick="closeExportModal()" class="px-4 py-2 bg-gray-200 dark:bg-[#1f2937] rounded">Cancel</button>
      <button onclick="submitExport()" class="px-4 py-2 bg-green-600 text-white rounded">Export</button>
    </div>
  </div>
</div>
<!-- Header Section -->
<div class="bg-gradient-to-r from-blue-600 to-blue-800 dark:from-blue-900 dark:to-blue-950 rounded-xl p-6 text-white shadow-lg">
<div class="flex flex-wrap justify-between items-start gap-4">
<div class="flex flex-col gap-2">
<p class="text-4xl font-black leading-tight">Student Profiles</p>
<p class="text-blue-100 text-base font-normal">Complete student data from all tables in comprehensive table format</p>
</div>
<div class="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
<p class="text-sm text-blue-50">Total Records: <span class="font-bold text-xl" id="count-records">0</span></p>
</div>
</div>
</div>

<!-- Search and Filter Section -->
<div class="bg-white dark:bg-[#1a202c] rounded-xl border border-[#e5e7eb] dark:border-[#2d3748] p-4 shadow-sm">
<div class="flex flex-wrap gap-3 items-center">
<div class="flex-1 min-w-xs">
<input type="text" id="studentSearch" placeholder="Search by name, ID, email or phone..." class="w-full px-4 py-2 border border-[#e5e7eb] dark:border-[#4a5568] rounded-lg bg-white dark:bg-[#2d3748] text-[#111418] dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
</div>
<button onclick="document.getElementById('studentSearch').value = ''; location.reload();" class="px-4 py-2 bg-gray-200 dark:bg-[#2d3748] text-gray-800 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-[#4a5568] transition-colors font-medium text-sm">
<span class="material-symbols-outlined inline text-sm mr-1">refresh</span>Reset
</button>
</div>
</div>

<div class="bg-white dark:bg-[#1a202c] rounded-xl border border-[#e5e7eb] dark:border-[#2d3748] overflow-hidden shadow-md">
<div class="overflow-x-auto">
<table class="w-full text-left border-collapse text-xs">
<thead>
<tr class="bg-gradient-to-r from-[#f3f4f6] to-[#e5e7eb] dark:from-[#2d3748] dark:to-[#1a202c] border-b-2 border-[#d1d5db] dark:border-[#4a5568]">
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider sticky left-0 bg-gradient-to-r from-[#f3f4f6] to-[#e5e7eb] dark:from-[#2d3748] dark:to-[#1a202c] z-10">Name</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">ID</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Email</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Phone</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Gender</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">DOB</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Community</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Religion</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Status</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">School</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">HSC %</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Cutoff</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">TNEA Elig.</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">TNEA Avg</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Preferred</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Quota</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Allotted</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Order</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Cons. #</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Counsel Status</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Payment</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Documents</th>
<th class="px-4 py-4 text-xs font-bold text-[#1f2937] dark:text-[#e2e8f0] uppercase tracking-wider">Action</th>
</tr>
</thead>
<tbody id="students-rows" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"></tbody>
</table>
</div>
</div>

</div>
</main>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
<script>
// CONFIG: values injected from .env
const SUPABASE_URL = 'https://izxxhnrkcsnnabdhvixh.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6eHhobnJrY3NubmFiZGh2aXhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NzkzMDYsImV4cCI6MjA4NTE1NTMwNn0.mVPXk2XF9DzGsZo_SJuTHcXPArdWywxLWJZw3DD9gkE';

let supabaseClient = null;
if (SUPABASE_URL.startsWith('http')) {
  try {
    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  } catch (err) {
    console.error('Supabase client init error', err);
    supabaseClient = null;
  }
} else {
  console.warn('Supabase URL not configured - client disabled');
}

// Utility maps
let academicsByStudent = {};
let admissionsByStudent = {};
let applicationsByStudent = {};
let documentsByApp = {};
let counsellingByStudent = {};
let paymentsByStudent = {};
let deptMap = {};

async function loadData() {
  if (!supabaseClient) return showConfigError();

  // fetch core tables in parallel
  const [sRes, aRes, applRes, admRes, cRes, dRes, pRes, deptRes] = await Promise.all([
    supabaseClient.from('students').select('*'),
    supabaseClient.from('academics').select('*'),
    supabaseClient.from('admission_applications').select('*'),
    supabaseClient.from('admissions').select('*'),
    supabaseClient.from('counselling_records').select('*'),
    supabaseClient.from('documents').select('*'),
    supabaseClient.from('payments').select('*'),
    supabaseClient.from('departments').select('*')
  ]);

  const students = sRes.data || [];
  const academics = aRes.data || [];
  const applications = applRes.data || [];
  const admissions = admRes.data || [];
  const counselling = cRes.data || [];
  const documents = dRes.data || [];
  const payments = pRes.data || [];
  const departments = deptRes.data || [];

  // Build department lookup
  deptMap = {};
  departments.forEach(d => {
    if(!d) return;
    const id = d.id !== undefined && d.id !== null ? String(d.id) : null;
    const name = d.dept_name || d.name || d.dept || d.deptName || d.department_name || d.department || '';
    if(id) deptMap[id] = name || id;
  });

  // Build maps
  academicsByStudent = {};
  academics.forEach(ac => {
    const sid = ac.student_id || ac.student || ac.id;
    if (sid) academicsByStudent[sid] = ac;
  });

  applicationsByStudent = {};
  applications.forEach(ap => {
    const sid = ap.student_id || ap.student || ap.studentId;
    if (!sid) return;
    applicationsByStudent[sid] = applicationsByStudent[sid] || [];
    applicationsByStudent[sid].push(ap);
  });

  admissionsByStudent = {};
  admissions.forEach(ad => {
    const sid = ad.student_id || ad.student || ad.studentId;
    if (!sid) return;
    admissionsByStudent[sid] = admissionsByStudent[sid] || [];
    admissionsByStudent[sid].push(ad);
  });

  documentsByApp = {};
  documents.forEach(doc => {
    const appId = doc.app_id || doc.application_id || doc.appId;
    if (!appId) return;
    documentsByApp[appId] = documentsByApp[appId] || [];
    documentsByApp[appId].push(doc);
  });

  counsellingByStudent = {};
  counselling.forEach(c => {
    const sid = c.student_id || c.student || c.studentId || c.applicant_id;
    if (sid) {
      counsellingByStudent[sid] = counsellingByStudent[sid] || [];
      counsellingByStudent[sid].push(c);
    }
  });

  paymentsByStudent = {};
  payments.forEach(p => {
    const sid = p.student_id || p.student || p.applicant_id || p.app_id;
    if (sid) {
      paymentsByStudent[sid] = paymentsByStudent[sid] || [];
      paymentsByStudent[sid].push(p);
    }
  });

  renderTable(students);
  populateExportFields();
}

function showConfigError() {
  const tbody = document.getElementById('students-rows');
  tbody.innerHTML = '<tr><td colspan="23" class="px-6 py-12 text-center"><div class="flex flex-col items-center gap-3"><span class="material-symbols-outlined text-6xl text-slate-300">error</span><p class="text-base font-semibold text-slate-600 dark:text-slate-400">Supabase is not configured. Please set SUPABASE_URL and SUPABASE_ANON_KEY in the script.</p></div></td></tr>';
}

function renderTable(students) {
  const tbody = document.getElementById('students-rows');
  tbody.innerHTML = '';
  // helper to pick the first available field from possible keys
  function pick(obj, ...keys){
    if(!obj) return null;
    for(const k of keys){
      if(obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== '') return obj[k];
    }
    return null;
  }
  students.forEach(student => {
    const sid = student.id || student.student_id;
    const academic = academicsByStudent[sid] || {};
    const apps = applicationsByStudent[sid] || [];
    const counsel = counsellingByStudent[sid] || [];
    const pays = paymentsByStudent[sid] || [];

    // normalized fields with fallbacks
    const phone = pick(student, 'phone', 'whatsapp_number', 'mobile', 'contact_number', 'phone_number') || 'N/A';
    const dob = pick(student, 'dob', 'date_of_birth', 'birth_date') || 'N/A';
    const community = pick(student, 'community', 'community_name') || 'N/A';
    const religion = pick(student, 'religion', 'religion_name') || 'N/A';
    const fullName = pick(student, 'full_name', 'name') || 'N/A';
    const uniqueId = pick(student, 'unique_id', 'id') || 'N/A';
    const plus2 = pick(student, 'plus2_percentage', 'plus2_percent', 'hsc_percentage') || 'N/A';
    const schoolName = pick(academic, 'school_name', 'school', 'institute_name') || 'N/A';

    // resolve preferred department names from applications (map ids to names when necessary)
    // Resolve preferred departments from multiple sources: application rows, admissions table, academics
    const prefCandidates = [];
    // from admission_applications
    apps.forEach(a => {
      const fields = ['preferred_dept_name','preferred_dept','preferred_dept_id','preferred_department_id','preferredDept','preferredDeptId','dept_id','department_id','dept_name','dept'];
      for(const f of fields){ if(a[f]) prefCandidates.push(a[f]); }
    });
    // from admissions table (admissionsByStudent)
    (admissionsByStudent[sid]||[]).forEach(ad => {
      const fields = ['preferred_dept_name','preferred_dept','preferred_dept_id','preferred_department_id','preferredDept','preferredDeptId','dept_id','department_id','dept_name','dept'];
      for(const f of fields){ if(ad[f]) prefCandidates.push(ad[f]); }
    });
    // from academics/ad-hoc student fields
    const acadPref = pick(academic, 'preferred_dept_name','preferred_dept','preferred_dept_id','dept','dept_id');
    if(acadPref) prefCandidates.push(acadPref);

    // normalize and map to department names where possible
    const preferredSet = new Set();
    prefCandidates.forEach(candidate => {
      if(!candidate) return;
      const key = String(candidate).trim();
      if(/^[0-9]+$/.test(key) && deptMap[key]) preferredSet.add(deptMap[key]);
      else if(deptMap[key]) preferredSet.add(deptMap[key]);
      else preferredSet.add(key);
    });
    const preferredNames = Array.from(preferredSet).join(', ') || 'N/A';

    // resolve allotted department names from counselling records
    const allottedNames = (counsel.map(c => {
      const candidate = c.dept_name || c.allotted_dept_name || c.allotted_dept || c.allotted_dept_id || c.dept_id || c.allotted_deptid || null;
      if(!candidate) return null;
      const key = String(candidate);
      if(/^[0-9]+$/.test(key) && deptMap[key]) return deptMap[key];
      return deptMap[key] || candidate;
    }).filter(Boolean).join(', ') || 'N/A');

    // Determine counsel status: if any counselling record shows an allotment, mark Completed
    const hasAllotment = counsel.some(c => {
      return !!(c && (c.allotment_order_number || c.allotted_dept || c.allotted_dept_id || c.dept_name || c.dept_id || c.consortium_number));
    });
    const counselStatusDisplay = hasAllotment ? 'Completed' : (counsel.map(c=>c.status||'N/A').filter(Boolean).join(', ') || 'N/A');

    // build documents html per application
    let docsHtml = '';
    if (apps.length) {
      apps.forEach(app => {
        const appId = app.app_id || app.id || app.application_id;
        const docList = documentsByApp[appId] || [];
        docsHtml += `<div class="mb-2"><div class="font-semibold text-xs mb-1 text-[#1f2937] dark:text-[#e2e8f0]">App #${appId || 'N/A'}</div><div class="flex flex-wrap gap-1">`;
        if (docList.length) {
          docList.forEach(d => {
            const url = d.document_url || d.url || d.path || '#';
            docsHtml += `<a href="${url}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 bg-blue-500 text-white text-xs font-bold py-1 px-2 rounded"> <span class="material-symbols-outlined text-xs">visibility</span></a>`;
          });
        } else {
          docsHtml += `<span class="text-xs text-slate-300 px-2">-</span>`;
        }
        docsHtml += `</div></div>`;
      });
    } else {
      docsHtml = `<span class="text-xs text-slate-400">No docs</span>`;
    }

    const nameInitial = (fullName || 'N')[0] || 'N';

    const row = document.createElement('tr');
    row.className = 'hover:bg-blue-50 dark:hover:bg-[#2d3748] transition-colors duration-150 border-l-4 border-l-transparent hover:border-l-blue-500';
    row.innerHTML = `
      <td class="px-4 py-3 text-xs font-semibold text-[#111418] dark:text-white sticky left-0 bg-white dark:bg-[#1a202c] hover:bg-blue-50 dark:hover:bg-[#2d3748]"><div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold text-xs">${nameInitial.toUpperCase()}</div>${(student.full_name || student.name || 'N/A')}</div></td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] font-mono bg-[#f9fafb] dark:bg-[#0f172a]">${student.unique_id || student.id || 'N/A'}</td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] truncate">${student.email || 'N/A'}</td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1]">${phone}</td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] capitalize">${student.gender || 'N/A'}</td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1]">${dob}</td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1]">${community}</td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1]">${religion}</td>
      <td class="px-4 py-3"><span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">${student.status || 'N/A'}</span></td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] truncate">${schoolName}</td>
      <td class="px-4 py-3 text-xs font-semibold text-[#1f2937] dark:text-[#f0f9ff] bg-amber-50 dark:bg-amber-900/20">${plus2}</td>
      <td class="px-4 py-3 text-xs font-bold text-[#7c2d12] dark:text-[#fed7aa] bg-orange-100 dark:bg-orange-900/30 rounded px-2">${academic.cutoff || academic.cutoff_score || 'N/A'}</td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1]">${academic.tnea_eligible || academic.tnea || 'N/A'}</td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1]">${academic.tnea_average || academic.tnea_avg || 'N/A'}</td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] truncate">${preferredNames}</td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1]">${(counsel.map(c=>c.quota_type||'N/A').join(', ') || 'N/A')}</td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] truncate">${allottedNames}</td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] font-mono">${(counsel.map(c=>c.allotment_order_number||c.order_number||'N/A').join(', ') || 'N/A')}</td>
      <td class="px-4 py-3 text-xs text-[#374151] dark:text-[#cbd5e1] font-mono">${(counsel.map(c=>c.consortium_number||'N/A').join(', ') || 'N/A')}</td>
      <td class="px-4 py-3">${(function(){
        const s = counselStatusDisplay || 'N/A';
        const cls = s==='Registered' ? 'bg-green-100 text-green-700' : (s==='Completed' ? 'bg-blue-100 text-blue-700' : (s==='Allotted' ? 'bg-blue-100 text-blue-700' : 'bg-yellow-100 text-yellow-700'));
        return `<span class="inline-block px-2 py-1 rounded-full text-xs font-semibold ${cls} mr-1">${s}</span>`;
      })()}</td>
      <td class="px-4 py-3"><span class="px-3 py-1 rounded-lg text-xs font-bold text-green-700 dark:text-green-300 bg-green-100 dark:bg-green-900/30">${(pays.map(p=>'₹'+(p.amount||'0')).join(', ')||'-')}</span></td>
      <td class="px-4 py-3 text-xs">${docsHtml}</td>
      <td class="px-4 py-3"><a href="/admin/student_profile_view?student_id=${encodeURIComponent(student.id || student.unique_id || student.email || '')}" class="inline-flex items-center gap-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-xs font-bold py-2 px-3 rounded-lg"> <span class="material-symbols-outlined text-sm">visibility</span>View</a></td>
    `;

    tbody.appendChild(row);
  });

  // update count
  const cnt = students.length || 0;
  const cEl = document.getElementById('count-records');
  if (cEl) cEl.textContent = cnt;
}

// Export modal helpers
const EXPORT_COLUMNS = ['full_name','unique_id','email','phone','gender','dob','community','religion','status','school_name','plus2_percentage','cutoff','tnea_eligible','tnea_average','preferred_depts','quota','allotted_dept','order','consortium_number','counsel_status','payments','documents'];

function populateExportFields() {
  const container = document.getElementById('exportFieldsContainer');
  if (!container) return;
  container.innerHTML = '';
  EXPORT_COLUMNS.forEach(col => {
    const lbl = document.createElement('label');
    lbl.className = 'inline-flex items-center gap-2 text-sm';
    lbl.innerHTML = `<input type="checkbox" class="export-field-checkbox" value="${col}" onchange="updateSelectedCount()" checked /> <span>${col}</span>`;
    container.appendChild(lbl);
  });
  updateSelectedCount();
}

function openExportModal() { const modal = document.getElementById('exportModal'); if (modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); } }
function closeExportModal() { const modal = document.getElementById('exportModal'); if (modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); } }
function selectAllFields(yes) { document.querySelectorAll('.export-field-checkbox').forEach(b=>b.checked=!!yes); updateSelectedCount(); }
function updateSelectedCount() { const boxes = Array.from(document.querySelectorAll('.export-field-checkbox')); const count = boxes.filter(b=>b.checked).length; const el = document.getElementById('selectedCount'); if (el) el.textContent = count; }

function submitExport() {
  const boxes = Array.from(document.querySelectorAll('.export-field-checkbox'));
  const selected = boxes.filter(b => b.checked).map(b => b.value);
  // build CSV from current DOM rows
  const rows = [];
  const header = selected;
  rows.push(header.join(','));
  const tbodyRows = document.querySelectorAll('#students-rows > tr');
  tbodyRows.forEach(tr => {
    const data = {};
    const tds = tr.querySelectorAll('td');
    data.full_name = tds[0]?.textContent.trim() || '';
    data.unique_id = tds[1]?.textContent.trim() || '';
    data.email = tds[2]?.textContent.trim() || '';
    data.phone = tds[3]?.textContent.trim() || '';
    data.gender = tds[4]?.textContent.trim() || '';
    data.dob = tds[5]?.textContent.trim() || '';
    data.community = tds[6]?.textContent.trim() || '';
    data.religion = tds[7]?.textContent.trim() || '';
    data.status = tds[8]?.textContent.trim() || '';
    data.school_name = tds[9]?.textContent.trim() || '';
    data.plus2_percentage = tds[10]?.textContent.trim() || '';
    data.cutoff = tds[11]?.textContent.trim() || '';
    data.tnea_eligible = tds[12]?.textContent.trim() || '';
    data.tnea_average = tds[13]?.textContent.trim() || '';
    data.preferred_depts = tds[14]?.textContent.trim() || '';
    data.quota = tds[15]?.textContent.trim() || '';
    data.allotted_dept = tds[16]?.textContent.trim() || '';
    data.order = tds[17]?.textContent.trim() || '';
    data.consortium_number = tds[18]?.textContent.trim() || '';
    data.counsel_status = tds[19]?.textContent.trim() || '';
    data.payments = tds[20]?.textContent.trim() || '';
    data.documents = tds[21]?.textContent.trim() || '';

    const line = selected.map(k => `"${(data[k]||'').replace(/"/g,'""')}"`).join(',');
    rows.push(line);
  });

  const csv = rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'students_export.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// Search functionality
const searchInput = document.getElementById('studentSearch');
if (searchInput) {
  searchInput.addEventListener('keyup', function(e) {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#students-rows tr');
    rows.forEach(row => {
      if (row.textContent.toLowerCase().includes(searchTerm)) row.style.display = ''; else row.style.display = 'none';
    });
    const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
    const recordCount = document.getElementById('count-records');
    if (recordCount) recordCount.textContent = visibleRows.length;
  });
}

// Auto-adjust table width on resize
window.addEventListener('resize', function() { const table = document.querySelector('table'); if (table) table.style.minWidth = Math.max(1200, window.innerWidth - 40) + 'px'; });

// Logout handler
const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) logoutBtn.addEventListener('click', (e) => { e.preventDefault(); window.location.href = '/auth/logout'; });

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  if (supabaseClient) loadData().catch(err => console.error('loadData error', err));
  else showConfigError();
});
</script>
</body>
</html>
