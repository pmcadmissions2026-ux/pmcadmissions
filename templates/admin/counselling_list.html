<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Counselling - PMC Engineering</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>
        body {
            font-family: 'Lexend', sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .active-nav {
            background-color: #137fec;
            color: white !important;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-white min-h-screen flex flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] px-6 py-3 sticky top-0 z-50">
<div class="flex items-center gap-4">
<div class="text-primary">
<svg fill="none" height="32" viewbox="0 0 48 48" width="32" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-[#111418] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Er. Perumal Manimekalai College of Engineering</h2>
</div>
<div class="flex items-center gap-4">
<a href="{{ url_for('auth.logout') }}" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">Logout</a>
</div>
</header>

<div class="flex flex-1">
<aside class="w-56 border-r border-solid border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#111827] hidden md:flex flex-col">
<nav class="flex-1 overflow-y-auto px-2 py-6 flex flex-col gap-2">
<a href="#" data-route="counselling_list" class="flex items-center gap-3 px-4 py-2 text-white bg-primary rounded-lg transition-colors active-nav">
<span class="material-symbols-outlined text-xl">how_to_vote</span>
<span class="text-sm font-medium">Counselling</span>
</a>
</nav>
<div class="border-t border-[#e5e7eb] dark:border-[#2d3748] px-4 py-4">
<p class="text-[10px] uppercase tracking-wider text-[#617589] font-bold px-3">{{ user.name }}</p>
<p class="text-[10px] uppercase tracking-wider text-[#617589] font-bold px-3">{{ user.role }}</p>
</div>
</aside>

<main class="flex-1 overflow-y-auto">
<div class="max-w-[1400px] mx-auto p-6 flex flex-col gap-6">
<div id="flashContainer"></div>

<div class="flex flex-wrap justify-between items-end gap-3">
<div class="flex min-w-72 flex-col gap-1">
<p class="text-[#111418] dark:text-white text-3xl font-black leading-tight tracking-[-0.033em]">Counselling</p>
<p class="text-[#617589] dark:text-[#a0aec0] text-base font-normal leading-normal">Students who have submitted documents and are ready for counselling.</p>
</div>
</div>

<div class="flex flex-col gap-8">

<!-- PENDING STUDENTS TABLE -->
<div class="flex flex-col bg-white dark:bg-[#1a202c] rounded-xl border border-[#e5e7eb] dark:border-[#2d3748] overflow-hidden">
<div class="flex items-center justify-between px-6 py-5 border-b border-[#e5e7eb] dark:border-[#2d3748]">
<h2 class="text-[#111418] dark:text-white text-xl font-bold leading-tight">Pending Counselling</h2>
<span id="pendingCount" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400">0 Student(s)</span>
</div>

<div class="overflow-x-auto">
<table class="w-full text-left border-collapse">
<thead>
<tr class="bg-[#f8fafc] dark:bg-[#2d3748] border-b border-[#e5e7eb] dark:border-[#2d3748]">
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">App #</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Student Name</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Unique ID</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Documents</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Applied</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Application #</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Applied Date</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Action</th>
</tr>
</thead>
<tbody id="pending-tbody" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"></tbody>
</table>
</div>
</div>

<!-- APPLIED (STEP 1) STUDENTS TABLE -->
<div class="flex flex-col bg-white dark:bg-[#1a202c] rounded-xl border border-[#e5e7eb] dark:border-[#2d3748] overflow-hidden">
<div class="flex items-center justify-between px-6 py-5 border-b border-[#e5e7eb] dark:border-[#2d3748]">
<h2 class="text-[#111418] dark:text-white text-xl font-bold leading-tight">Applied (Step 1)</h2>
<span id="appliedCount" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400">0 Student(s)</span>
</div>

<div class="overflow-x-auto">
<table class="w-full text-left border-collapse">
<thead>
<tr class="bg-[#f8fafc] dark:bg-[#2d3748] border-b border-[#e5e7eb] dark:border-[#2d3748]">
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">App #</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Student Name</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Unique ID</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Applied</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Application #</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Applied Date</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Action</th>
</tr>
</thead>
<tbody id="applied-tbody" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"></tbody>
</table>
</div>
</div>

<!-- COMPLETED/FILLED STUDENTS TABLE -->
<div class="flex flex-col bg-white dark:bg-[#1a202c] rounded-xl border border-[#e5e7eb] dark:border-[#2d3748] overflow-hidden">
<div class="flex items-center justify-between px-6 py-5 border-b border-[#e5e7eb] dark:border-[#2d3748]">
<h2 class="text-[#111418] dark:text-white text-xl font-bold leading-tight">Completed Counselling</h2>
<span id="completedCount" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">0 Student(s)</span>
</div>

<div class="overflow-x-auto">
<table class="w-full text-left border-collapse">
<thead>
<tr class="bg-[#f8fafc] dark:bg-[#2d3748] border-b border-[#e5e7eb] dark:border-[#2d3748]">
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">App #</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Student Name</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Unique ID</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Allotted Quota</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Allotted Department</th>
<th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Details</th>
</tr>
</thead>
<tbody id="completed-tbody" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"></tbody>
</table>
</div>
</div>

</div>
</div>
</main>
</div>

<script>
async function loadCounsellingList() {
    const docsRes = await fetch('/api/_documents').then(r => r.json()).catch(()=>({ok:false, items:[]}));
    let items = [];
    if (Array.isArray(docsRes)) items = docsRes;
    else if (docsRes && docsRes.ok && Array.isArray(docsRes.items)) items = docsRes.items;

    const appIds = new Set();
    items.forEach(d => { const aid = d.app_id || d.appid || d.application_id; if(aid) appIds.add(String(aid)); });

    // Build document counts keyed by app_id from the documents list
    const docCounts = {};
    (items||[]).forEach(d => { const aid = String(d.app_id || d.appid || d.application_id || ''); if(!aid) return; docCounts[aid] = (docCounts[aid] || 0) + 1; });

    // fetch admission applications, students, counselling records and departments
    const [appsRes, studentsRes, counsellingRes, deptsRes] = await Promise.all([
        fetch('/api/_admission_applications').then(r=>r.json()).catch(()=>({ok:false, items:[]})),
        fetch('/api/students').then(r=>r.json()).catch(()=>({ok:false, items:[]})),
        fetch('/api/counselling_records').then(r=>r.json()).catch(()=>({ok:false, items:[]})),
        fetch('/api/departments').then(r=>r.json()).catch(()=>({ok:false, items:[]}))
    ]);

    let apps = Array.isArray(appsRes) ? appsRes : (appsRes && appsRes.ok && Array.isArray(appsRes.items) ? appsRes.items : []);
    let students = Array.isArray(studentsRes) ? studentsRes : (studentsRes && studentsRes.ok && Array.isArray(studentsRes.items) ? studentsRes.items : []);
    let counselling = Array.isArray(counsellingRes) ? counsellingRes : (counsellingRes && counsellingRes.ok && Array.isArray(counsellingRes.items) ? counsellingRes.items : []);
    let departments = Array.isArray(deptsRes) ? deptsRes : (deptsRes && deptsRes.ok && Array.isArray(deptsRes.items) ? deptsRes.items : []);

    // build department id -> name map
    const deptMap = {};
    (departments||[]).forEach(d => {
        const id = d && (d.id || d.dept_id || d.department_id) ? (d.id || d.dept_id || d.department_id) : null;
        const name = d && (d.dept_name || d.name || d.department_name) ? (d.dept_name || d.name || d.department_name) : null;
        if(id && name) deptMap[String(id)] = name;
    });

    const appMap = {};
    apps.forEach(a => { if(a && a.app_id && appIds.has(String(a.app_id))) appMap[String(a.app_id)] = a; });
    const studentMap = {};
    students.forEach(s => { if(s && s.id) studentMap[String(s.id)] = s; });
    const counsellingMap = {};
    counselling.forEach(c => { if(c && c.app_id) counsellingMap[String(c.app_id)] = c; });

    // build union of appIds and apps present
    const allAppIds = new Set(Object.keys(appMap));
    appIds.forEach(x=> allAppIds.add(x));

    const pendingTbody = document.getElementById('pending-tbody');
    const appliedTbody = document.getElementById('applied-tbody');
    const completedTbody = document.getElementById('completed-tbody');
    const pendingCount = document.getElementById('pendingCount');
    const appliedCount = document.getElementById('appliedCount');
    const completedCount = document.getElementById('completedCount');

    pendingTbody.innerHTML = '';
    appliedTbody.innerHTML = '';
    completedTbody.innerHTML = '';
    let pending = 0, applied = 0, completed = 0;

    if (allAppIds.size === 0) {
        pendingTbody.innerHTML = '<tr><td colspan="8" class="px-6 py-12 text-center text-slate-500"><span class="material-symbols-outlined text-4xl mb-2">folder_open</span><p class="text-sm font-medium">No students with uploaded documents</p></td></tr>';
        pendingCount.textContent = '0 Student(s)';
        appliedCount.textContent = '0 Student(s)';
        completedCount.textContent = '0 Student(s)';
        return;
    }

    Array.from(allAppIds).sort((a,b)=>Number(a)-Number(b)).forEach(appId => {
        const app = appMap[appId] || { app_id: Number(appId), student_id: null };
        const student = app.student_id ? studentMap[String(app.student_id)] : null;
        const c = counsellingMap[appId] || null;

        // Define states:
        // isApplied: user completed step 1 (applied_gq/applied_mq or has counselling_application_number)
        // isAllotted: final allotment exists (allotted_dept_id present)
        const isApplied = !!(c && (c.applied_gq || c.applied_mq || c.counselling_application_number || c.gq_applied_at || c.mq_applied_at));
        // Consider a record 'allotted' (completed) only when an allotted department exists
        // AND there is a documented allotment identifier (order number/url or consortium number).
        const hasAllotmentIdentifier = !!(c && (c.allotment_order_number || c.allotment_order_url || c.consortium_number));
        const isAllotted = !!(c && (c.allotted_dept_id || c.allotted_dept) && hasAllotmentIdentifier);

        const appliedLabel = isApplied ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-800">Yes</span>' : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-red-50 text-red-700">No</span>';

        const applicationNumber = c && (c.counselling_application_number || c.gq_application_number || c.mq_application_number) ? (c.counselling_application_number || c.gq_application_number || c.mq_application_number) : '-';
        const appliedDateRaw = c && (c.gq_applied_at || c.mq_applied_at) ? (c.gq_applied_at || c.mq_applied_at) : null;
        const appliedDate = appliedDateRaw ? new Date(appliedDateRaw).toLocaleString() : '-';

        const actionHref = isAllotted ? ('counselling_form.html?app_id='+appId) : (isApplied ? ('counselling_form.html?app_id='+appId) : ('counselling_apply.html?app_id='+appId));
        const actionClass = isAllotted || isApplied ? 'bg-primary text-white' : 'bg-yellow-500 text-white';
        const actionIcon = isAllotted || isApplied ? 'how_to_vote' : 'edit';
        const actionLabel = isAllotted || isApplied ? 'Start Counselling' : 'Mark Applied';

        const tr = document.createElement('tr');
        tr.className = 'hover:bg-[#f0f2f4] dark:hover:bg-[#2d3748] transition-colors';

        // Build row HTML per target table so column count matches headers
        let rowHtml = '';
        if (isAllotted) {
            // Completed table: App #, Student Name, Unique ID, Allotted Quota, Allotted Department, Details
            const quotaLabel = c && (c.quota_type || (c.applied_gq ? 'GQ' : (c.applied_mq ? 'MQ' : null))) ? (c.quota_type || (c.applied_gq ? 'GQ' : (c.applied_mq ? 'MQ' : '-'))) : '-';
            const deptName = (c && (c.allotted_dept || c.allotted_dept_name)) ? (c.allotted_dept || c.allotted_dept_name) : (c && c.allotted_dept_id ? (deptMap[String(c.allotted_dept_id)] || ('Dept #'+c.allotted_dept_id)) : '-');
            const details = (c && (c.allotment_order_number || c.allotment_order_url || c.consortium_number)) ? (c.allotment_order_number || c.consortium_number || (c.allotment_order_url ? ('<a href="'+c.allotment_order_url+'" target="_blank">View</a>') : '-')) : '-';
            rowHtml = `
                <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-800">#${appId}</span></td>
                <td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-medium">${(student && (student.student_name || student.full_name)) || ''}</td>
                <td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-mono">${(student && student.unique_id) || ''}</td>
                <td class="px-6 py-4 text-sm text-[#111418] dark:text-white">${quotaLabel}</td>
                <td class="px-6 py-4 text-sm text-[#111418] dark:text-white">${deptName}</td>
                <td class="px-6 py-4 text-sm text-[#111418] dark:text-white">${details}</td>
            `;
            tr.innerHTML = rowHtml;
            completedTbody.appendChild(tr); completed++;
        } else if (isApplied) {
            // Applied table: App #, Student Name, Unique ID, Applied, Application #, Applied Date, Action
            rowHtml = `
                <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-800">#${appId}</span></td>
                <td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-medium">${(student && (student.student_name || student.full_name)) || ''}</td>
                <td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-mono">${(student && student.unique_id) || ''}</td>
                <td class="px-6 py-4 text-sm">${appliedLabel}</td>
                <td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-mono">${applicationNumber}</td>
                <td class="px-6 py-4 text-sm text-[#111418] dark:text-white">${appliedDate}</td>
                <td class="px-6 py-4"><a href="${actionHref}" class="inline-flex items-center gap-2 ${actionClass} text-xs font-bold py-2 px-4 rounded-lg"> <span class="material-symbols-outlined text-sm">${actionIcon}</span> ${actionLabel}</a></td>
            `;
            tr.innerHTML = rowHtml;
            appliedTbody.appendChild(tr); applied++;
        } else {
            // Pending table: include Documents column
            rowHtml = `
                <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-800">#${appId}</span></td>
                <td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-medium">${(student && (student.student_name || student.full_name)) || ''}</td>
                <td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-mono">${(student && student.unique_id) || ''}</td>
                <td class="px-6 py-4 text-sm text-[#111418] dark:text-white"><span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-50 text-blue-700"> <span class="material-symbols-outlined text-sm">description</span> ${docCounts[String(appId)] || 0} file(s)</span></td>
                <td class="px-6 py-4 text-sm">${appliedLabel}</td>
                <td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-mono">${applicationNumber}</td>
                <td class="px-6 py-4 text-sm text-[#111418] dark:text-white">${appliedDate}</td>
                <td class="px-6 py-4"><a href="${actionHref}" class="inline-flex items-center gap-2 ${actionClass} text-xs font-bold py-2 px-4 rounded-lg"> <span class="material-symbols-outlined text-sm">${actionIcon}</span> ${actionLabel}</a></td>
            `;
            tr.innerHTML = rowHtml;
            pendingTbody.appendChild(tr); pending++;
        }
    });

    pendingCount.textContent = pending + ' Student(s)';
    appliedCount.textContent = applied + ' Student(s)';
    completedCount.textContent = completed + ' Student(s)';
}

document.addEventListener('DOMContentLoaded', () => { loadCounsellingList(); });
</script>
</body>
</html>
