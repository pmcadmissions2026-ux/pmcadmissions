<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Super Admin Dashboard - PMC Engineering</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>
        body {
            font-family: 'Lexend', sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .active-nav {
            background-color: #137fec;
            color: white !important;
        }
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
        }
        .tab-btn {
            padding: 0.75rem 1rem;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            border-bottom-color: #137fec;
            color: #137fec;
        }
        .data-table {
            max-height: 600px;
            overflow-y: auto;
        }
        .table-row:hover {
            background-color: rgba(19, 127, 236, 0.05);
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-white min-h-screen flex flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] px-6 py-3 sticky top-0 z-50">
<div class="flex items-center gap-4">
<div class="text-primary">
<svg fill="none" height="32" viewbox="0 0 48 48" width="32" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-[#111418] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Master Data - PMC Engineering</h2>
</div>
<div class="flex items-center gap-4">
<div class="flex items-center gap-2 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-3 py-1 rounded-full text-xs font-bold">
<span class="inline-block w-2 h-2 bg-green-600 rounded-full animate-pulse"></span>
Live - Read Only
</div>
<a href="/auth/logout" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium">Logout</a>
</div>
</header>

<div class="flex flex-1">
<aside class="w-56 border-r border-solid border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#111827] hidden md:flex flex-col">
<nav class="flex-1 overflow-y-auto px-2 py-6 flex flex-col gap-2">
<a href="/admin/super_admin_dashboard" class="flex items-center gap-3 px-4 py-2 text-white bg-primary rounded-lg transition-colors active-nav">
<span class="material-symbols-outlined text-xl">dashboard</span>
<span class="text-sm font-medium">Master Dashboard</span>
</a>
<a href="/templates/admin/student_profiles.html" class="flex items-center gap-3 px-4 py-2 text-[#111418] dark:text:white hover:bg-[#f0f2f4] dark:hover:bg-[#2d3748] rounded-lg transition-colors">
<span class="material-symbols-outlined text-xl">account_circle</span>
<span class="text-sm font-medium">Student Profiles</span>
</a>
<a href="/templates/admin/staff_management.html" class="flex items-center gap-3 px-4 py-2 text-[#111418] dark:text:white hover:bg-[#f0f2f4] dark:hover:bg-[#2d3748] rounded-lg transition-colors">
<span class="material-symbols-outlined text-xl">people</span>
<span class="text-sm font-medium">Staff Management</span>
</a>
<a href="/templates/admin/departments.html" class="flex items-center gap-3 px-4 py-2 text-[#111418] dark:text:white hover:bg-[#f0f2f4] dark:hover:bg-[#2d3748] rounded-lg transition-colors">
<span class="material-symbols-outlined text-xl">apartment</span>
<span class="text-sm font-medium">Departments</span>
</a>
<div class="my-2 border-t border-[#e5e7eb] dark:border-[#2d3748]"></div>
<a href="/templates/admin/reports.html" class="flex items-center gap-3 px-4 py-2 text-[#111418] dark:text:white hover:bg-[#f0f2f4] dark:hover:bg-[#2d3748] rounded-lg transition-colors">
<span class="material-symbols-outlined text-xl">analytics</span>
<span class="text-sm font-medium">Reports</span>
</a>
</nav>
<div class="border-t border-[#e5e7eb] dark:border-[#2d3748] px-4 py-4">
<p id="sidebar-user-name" class="text-[10px] uppercase tracking-wider text-[#617589] font-bold px-3">--</p>
<p class="text-[10px] uppercase tracking-wider text-[#617589] font-bold px-3">SUPER ADMIN</p>
</div>
</aside>

<main class="flex-1 overflow-y-auto">
<div class="max-w-[1400px] mx-auto p-6 flex flex-col gap-6">

<!-- Page Header -->
<div class="flex flex-wrap justify-between items-end gap-3">
<div class="flex min-w-72 flex-col gap-1">
<p class="text-[#111418] dark:text-white text-3xl font-black leading-tight tracking-[-0.033em]">Master Data Dashboard</p>
<p class="text-[#617589] dark:text-[#a0aec0] text-base font-normal leading-normal">Complete system data in read-only view</p>
</div>
</div>

<!-- Key Metrics Section -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
<div class="bg-white dark:bg-[#1a202c] p-6 rounded-lg border border-[#e5e7eb] dark:border-[#2d3748]">
<div class="flex items-center justify-between mb-2">
<p class="text-[#617589] dark:text-[#a0aec0] text-xs font-semibold uppercase">Total Enquiries</p>
<span class="p-2 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-lg material-symbols-outlined text-lg">mail</span>
</div>
<p class="text-3xl font-black text-[#111418] dark:text-white"><span id="total-enquiries">0</span></p>
<p class="text-xs text-[#617589] dark:text-[#a0aec0] mt-1"><span id="open-enquiries">0</span> Open</p>
</div>

<div class="bg-white dark:bg-[#1a202c] p-6 rounded-lg border border-[#e5e7eb] dark:border-[#2d3748]">
<div class="flex items-center justify-between mb-2">
<p class="text-[#617589] dark:text-[#a0aec0] text-xs font-semibold uppercase">Applications</p>
<span class="p-2 bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 rounded-lg material-symbols-outlined text-lg">how_to_reg</span>
</div>
<p class="text-3xl font-black text-[#111418] dark:text-white"><span id="total-applications">0</span></p>
<p class="text-xs text-[#617589] dark:text-[#a0aec0] mt-1"><span id="approved-applications">0</span> Approved</p>
</div>

<div class="bg-white dark:bg-[#1a202c] p-6 rounded-lg border border-[#e5e7eb] dark:border-[#2d3748]">
<div class="flex items-center justify-between mb-2">
<p class="text-[#617589] dark:text-[#a0aec0] text-xs font-semibold uppercase">Counselled</p>
<span class="p-2 bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 rounded-lg material-symbols-outlined text-lg">how_to_vote</span>
</div>
<p class="text-3xl font-black text-[#111418] dark:text-white"><span id="total-counselled">0</span></p>
<p class="text-xs text-[#617589] dark:text-[#a0aec0] mt-1">Students Allotted</p>
</div>

<div class="bg-white dark:bg-[#1a202c] p-6 rounded-lg border border-[#e5e7eb] dark:border-[#2d3748]">
<div class="flex items-center justify-between mb-2">
<p class="text-[#617589] dark:text-[#a0aec0] text-xs font-semibold uppercase">Payments</p>
<span class="p-2 bg-amber-100 dark:bg-amber-900 text-amber-600 dark:text-amber-300 rounded-lg material-symbols-outlined text-lg">payments</span>
</div>
<p class="text-3xl font-black text-[#111418] dark:text-white">₹<span id="total-payment-amount">0</span></p>
<p class="text-xs text-[#617589] dark:text-[#a0aec0] mt-1"><span id="payment-count">0</span> Transactions</p>
</div>

<div class="bg-white dark:bg-[#1a202c] p-6 rounded-lg border border-[#e5e7eb] dark:border-[#2d3748]">
<div class="flex items-center justify-between mb-2">
<p class="text-[#617589] dark:text-[#a0aec0] text-xs font-semibold uppercase">Documents</p>
<span class="p-2 bg-orange-100 dark:bg-orange-900 text-orange-600 dark:text-orange-300 rounded-lg material-symbols-outlined text-lg">description</span>
</div>
<p class="text-3xl font-black text-[#111418] dark:text-white"><span id="documents-uploaded">0</span></p>
<p class="text-xs text-[#617589] dark:text-[#a0aec0] mt-1"><span id="documents-pending">0</span> Pending</p>
</div>
</div>

<!-- Tabbed Data Section -->
<div class="bg-white dark:bg-[#1a202c] rounded-lg border border-[#e5e7eb] dark:border-[#2d3748] overflow-hidden">
<!-- Tab Headers -->
<div class="flex gap-0 border-b border-[#e5e7eb] dark:border-[#2d3748] overflow-x-auto bg-[#f9fafb] dark:bg-[#111827]">
<button class="tab-btn active text-primary" onclick="showTab('enquiries')">
<span class="material-symbols-outlined inline text-lg">mail</span> Enquiries
</button>
<button class="tab-btn text-[#111418] dark:text-white" onclick="showTab('applications')">
<span class="material-symbols-outlined inline text-lg">how_to_reg</span> Document Upload
</button>
<button class="tab-btn text-[#111418] dark:text-white" onclick="showTab('admissions')">
<span class="material-symbols-outlined inline text-lg">verified_user</span> Branch Selection
</button>
<button class="tab-btn text-[#111418] dark:text-white" onclick="showTab('counselling')">
<span class="material-symbols-outlined inline text-lg">how_to_vote</span> Counselling
</button>
<button class="tab-btn text-[#111418] dark:text-white" onclick="showTab('payments')">
<span class="material-symbols-outlined inline text-lg">payments</span> Payments
</button>
<button class="tab-btn text-[#111418] dark:text-white" onclick="showTab('flow_summary')">
<span class="material-symbols-outlined inline text-lg">hub</span> Flow Summary
</button>
<button class="tab-btn text-[#111418] dark:text-white" onclick="showTab('documents')">
<span class="material-symbols-outlined inline text-lg">description</span> Documents
</button>
</div>

<!-- Tab Content -->
<div class="p-6">

<!-- ENQUIRIES Tab -->
<div id="enquiries" class="tab-pane active">
<div class="flex justify-between items-center mb-4 gap-4">
<h3 class="text-lg font-bold text-[#111418] dark:text-white">Enquiries (<span id="count-enquiries">0</span>)</h3>
<div class="flex gap-2">
<input type="text" placeholder="Search enquiries..." id="search_enquiries" class="px-3 py-2 border border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] rounded-lg text-sm text-[#111418] dark:text-white" />
<button onclick="filterTableLocal('enquiries')" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-blue-600">Search</button>
</div>
</div>
<div class="data-table" id="enquiries_data">
<table class="w-full border-collapse">
<thead class="sticky top-0 bg-[#f0f2f4] dark:bg-[#111827]">
<tr>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Enquiry ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Student Name</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Unique ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Email</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Phone</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Status</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Created</th>
</tr>
</thead>
<tbody id="enquiries-rows" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"></tbody>
</table>
</div>
<div class="flex justify-center gap-2 mt-4" id="enquiries_pagination"></div>
</div>

<!-- APPLICATIONS Tab -->
<div id="applications" class="tab-pane">
<div class="flex justify-between items-center mb-4 gap-4">
<h3 class="text-lg font-bold text-[#111418] dark:text-white">Document Upload (<span id="count-documents">0</span>)</h3>
<div class="flex gap-2">
<input type="text" placeholder="Search document uploads..." id="search_applications" class="px-3 py-2 border border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] rounded-lg text-sm text-[#111418] dark:text-white" />
<button onclick="filterTableLocal('applications')" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-blue-600">Search</button>
</div>
</div>
<div class="data-table" id="applications_data">
<table class="w-full border-collapse">
<thead class="sticky top-0 bg-[#f0f2f4] dark:bg-[#111827]">
<tr>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Application ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Student Name</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Unique ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Documents</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Status</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Submitted</th>
</tr>
</thead>
<tbody id="applications-rows" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"></tbody>
</table>
</div>
</div>

<!-- STUDENTS Tab -->
<div id="students" class="tab-pane">
<div class="flex justify-between items-center mb-4 gap-4">
<h3 class="text-lg font-bold text-[#111418] dark:text-white">All Students (<span id="count-students">0</span>)</h3>
<div class="flex gap-2">
<input type="text" placeholder="Search students..." id="search_students" class="px-3 py-2 border border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] rounded-lg text-sm text-[#111418] dark:text-white" />
<button onclick="searchTable('students')" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-blue-600">Search</button>
</div>
</div>
<div class="data-table" id="students_data">
<table class="w-full border-collapse">
<thead class="sticky top-0 bg-[#f0f2f4] dark:bg-[#111827]">
<tr>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Name</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Email</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Phone</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Created</th>
</tr>
</thead>
<tbody id="students-rows" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"></tbody>
</table>
</div>
<div class="flex justify-center gap-2 mt-4" id="students_pagination"></div>
</div>

<!-- ADMISSIONS Tab -->
<div id="admissions" class="tab-pane">
<div class="flex justify-between items-center mb-4 gap-4">
<h3 class="text-lg font-bold text-[#111418] dark:text-white">Branch Selection (<span id="count-admissions">0</span>)</h3>
<div class="flex gap-2">
<input type="text" placeholder="Search branch selection..." id="search_admissions" class="px-3 py-2 border border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] rounded-lg text-sm text-[#111418] dark:text-white" />
<button onclick="filterTableLocal('admissions')" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-blue-600">Search</button>
</div>
</div>
<div class="data-table" id="admissions_data">
<table class="w-full border-collapse">
<thead class="sticky top-0 bg-[#f0f2f4] dark:bg-[#111827]">
<tr>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Student Name</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Unique ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Preferred Dept</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Optional Depts</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Allotted Dept</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Status</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Assigned</th>
</tr>
</thead>
<tbody id="admissions-rows" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"></tbody>
</table>
</div>
<div class="flex justify-center gap-2 mt-4" id="admissions_pagination"></div>
</div>

<!-- COUNSELLING Tab -->
<div id="counselling" class="tab-pane">
<div class="flex justify-between items-center mb-4 gap-4">
<h3 class="text-lg font-bold text-[#111418] dark:text-white">Counselling (<span id="count-counselling">0</span>)</h3>
<div class="flex gap-2">
<input type="text" placeholder="Search counselling..." id="search_counselling" class="px-3 py-2 border border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] rounded-lg text-sm text-[#111418] dark:text-white" />
<button onclick="filterTableLocal('counselling')" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-blue-600">Search</button>
</div>
</div>
<div class="data-table" id="counselling_data">
<table class="w-full border-collapse">
<thead class="sticky top-0 bg-[#f0f2f4] dark:bg-[#111827]">
<tr>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Counselling ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Student Name</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Unique ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Allotted Department</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Allotted Quota</th>
</tr>
</thead>
<tbody id="counselling-rows" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"></tbody>
</table>
</div>
<div class="flex justify-center gap-2 mt-4" id="counselling_pagination"></div>
</div>

<!-- PAYMENTS Tab -->
<div id="payments" class="tab-pane">
<div class="flex justify-between items-center mb-4 gap-4">
<h3 class="text-lg font-bold text-[#111418] dark:text-white">Fee Payments (<span id="count-payments">0</span>)</h3>
<div class="flex gap-2">
<input type="text" placeholder="Search payments..." id="search_payments" class="px-3 py-2 border border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] rounded-lg text-sm text-[#111418] dark:text-white" />
<button onclick="filterTableLocal('payments')" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-blue-600">Search</button>
</div>
</div>
<div class="data-table" id="payments_data">
<table class="w-full border-collapse">
<thead class="sticky top-0 bg-[#f0f2f4] dark:bg-[#111827]">
<tr>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Payment ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">App ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Student Name</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Unique ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Bill No</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Mode</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Amount (₹)</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Date</th>
</tr>
</thead>
<tbody id="payments-rows" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"></tbody>
</table>
</div>
<div class="flex justify-center gap-2 mt-4" id="payments_pagination"></div>
</div>

<!-- FLOW SUMMARY Tab -->
<div id="flow_summary" class="tab-pane">
<div class="flex justify-between items-center mb-4 gap-4">
<h3 class="text-lg font-bold text-[#111418] dark:text-white">Flow Summary (<span id="count-flow-summary">0</span>)</h3>
<div class="flex gap-2">
<input type="text" placeholder="Search flow summary..." id="search_flow_summary" class="px-3 py-2 border border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] rounded-lg text-sm text-[#111418] dark:text-white" />
<button onclick="filterFlowSummary()" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-blue-600">Search</button>
</div>
</div>
<div class="data-table" id="flow_summary_data">
<table class="w-full border-collapse">
<thead class="sticky top-0 bg-[#f0f2f4] dark:bg-[#111827]">
<tr>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Student Name</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Unique ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Enquiry</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Branch</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Documents</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Counselling</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Payment</th>
</tr>
</thead>
<tbody id="flow-summary-rows" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"></tbody>
</table>
</div>
</div>

<!-- DOCUMENTS Tab -->
<div id="documents" class="tab-pane">
<div class="flex justify-between items-center mb-4 gap-4">
<h3 class="text-lg font-bold text-[#111418] dark:text-white">Documents (<span id="count-doc-items">0</span>)</h3>
<div class="flex gap-2">
<input type="text" placeholder="Search documents..." id="search_documents" class="px-3 py-2 border border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] rounded-lg text-sm text-[#111418] dark:text-white" />
<button onclick="filterTableLocal('documents')" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold hover:bg-blue-600">Search</button>
</div>
</div>
<div class="data-table" id="documents_data">
<table class="w-full border-collapse">
<thead class="sticky top-0 bg-[#f0f2f4] dark:bg-[#111827]">
<tr>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Document ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Student Name</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Unique ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Application ID</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Document Type</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Status</th>
<th class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-2 text-left text-xs font-bold text-[#617589] dark:text-[#a0aec0] uppercase">Uploaded</th>
</tr>
</thead>
<tbody id="documents-rows" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"></tbody>
</table>
</div>
<div class="flex justify-center gap-2 mt-4" id="documents_pagination"></div>
</div>

</div>
</div>

<div class="flex items-center justify-center gap-2 text-xs text-[#617589] dark:text-[#a0aec0] mt-4">
<span class="material-symbols-outlined text-sm">info</span>
<p>All data is read-only and updated in real-time from the database</p>
</div>

</div>
</main>
</div>

<script>
// Lightweight AdminAPI to call server REST endpoints and normalize responses
const API_ENDPOINTS = {
    enquiries: '/api/enquiries',
    admission_applications: '/api/_admission_applications',
    students: '/api/students',
    admissions: '/api/admissions',
    counselling_records: '/api/_counselling_records',
    payments: '/api/payments',
    documents: '/api/_documents',
    departments: '/api/departments'
};

const tableMapping = {
    enquiries: 'enquiries',
    applications: 'admission_applications',
    students: 'students',
    admissions: 'admissions',
    counselling: 'counselling_records',
    payments: 'payments',
    documents: 'documents'
};

const paginationState = {};

// In-memory student lookup maps to enrich other records
let studentsMapById = {};
let studentsMapByUnique = {};

const AdminAPI = {
    async list(tableName, limit = 500) {
        // Accept either mapped names or raw table names
        const endpoint = API_ENDPOINTS[tableName] || API_ENDPOINTS[tableName.replace(/s$/,'')];
        const url = endpoint || `/api/${tableName}`;
        let res;
        try {
            res = await fetch(url, {cache: 'no-store'});
        } catch (err) {
            console.warn('Fetch error for', url, err);
            // try fallback
            try { res = await fetch(`/api/${tableName}`, {cache: 'no-store'}); } catch(e) { return []; }
        }
        if (!res || !res.ok) {
            console.warn('Non-OK response from', url, res && res.status);
            // try alternate fallback url once
            try {
                const alt = `/api/${tableName}`;
                if (alt !== url) {
                    const altRes = await fetch(alt, {cache: 'no-store'}).catch(() => null);
                    if (altRes && altRes.ok) {
                        const altJson = await altRes.json().catch(() => null);
                        if (Array.isArray(altJson)) return altJson.slice(0, limit);
                        if (altJson && Array.isArray(altJson.data)) return altJson.data.slice(0, limit);
                    }
                }
            } catch (e) {
                // ignore
            }
            try { return (await (res && res.json ? res.json() : Promise.resolve({data:[]}))).data || []; } catch(e) { return []; }
        }
        const json = await res.json().catch(() => null);
        if (!json) return [];
        // Normalize: if response is {data: [...] } or plain array
        if (Array.isArray(json)) return json.slice(0, limit);
        if (json.data && Array.isArray(json.data)) return json.data.slice(0, limit);
        // fallback: try common keys
        for (const k of Object.keys(json)) {
            if (Array.isArray(json[k])) return json[k].slice(0, limit);
        }
        return [];
    }
};

async function loadDashboardData() {
    try {
        // Use allSettled so one failing endpoint doesn't abort all loads
        const results = await Promise.allSettled([
                AdminAPI.list('enquiries'),
                AdminAPI.list('admission_applications'),
                AdminAPI.list('students'),
                AdminAPI.list('admissions'),
                AdminAPI.list('counselling_records'),
                AdminAPI.list('payments'),
                AdminAPI.list('documents'),
                AdminAPI.list('departments')
        ]);
            const settled = results.map(r => r.status === 'fulfilled' ? r.value : []);
            const [enquiries, applications, students, admissions, counselling, payments, documents, departments] = settled;

        // build student lookup maps for enrichment
        studentsMapById = {};
        studentsMapByUnique = {};
        // additional lookup by email
        const studentsMapByEmail = {};
        students.forEach(s => {
            const sid = s.id || s.student_id || null;
            const uniq = s.unique_id || s.uniq_id || s.uniq || s.student_unique || null;
            if (sid) studentsMapById[String(sid)] = s;
            if (uniq) studentsMapByUnique[String(uniq)] = s;
            if (s.email) studentsMapByEmail[String(s.email).toLowerCase()] = s;
        });
        // build application map for documents -> application -> student resolution
        const applicationsMap = {};
        (applications||[]).forEach(a => { if(a && (a.app_id || a.appId)) applicationsMap[String(a.app_id || a.appId)] = a; });
        window._applicationsMap = applicationsMap;
        // build department map for id -> name
        const deptMap = {};
        (departments||[]).forEach(d => { if(d && (d.id || d.dept_id)) deptMap[String(d.id || d.dept_id)] = d.dept_name || d.name || d.dept_name || d.department || ''; });
        window._deptMap = deptMap;
        // build counselling map by app_id for allotted dept lookup
        const counsellingByApp = {};
        (counselling||[]).forEach(c => { const aid = c && (c.app_id || c.appId); if(aid) counsellingByApp[String(aid)] = c; });
        window._counsellingByApp = counsellingByApp;
        // attach email map for resolver
        window._studentsMapByEmail = studentsMapByEmail;

        // Metrics
        document.getElementById('total-enquiries').textContent = enquiries.length;
        document.getElementById('open-enquiries').textContent = enquiries.filter(e => (e.status||'').toLowerCase() === 'open').length;

        document.getElementById('total-applications').textContent = applications.length;
        document.getElementById('approved-applications').textContent = applications.filter(a => (a.application_status||'').toLowerCase() === 'approved').length;

        const counselledCount = counselling.filter(c => c.allotment_order_number || c.consortium_number || c.allotted_department_id || c.allotted_dept_id).length;
        document.getElementById('total-counselled').textContent = counselledCount;
        // per-tab counts
        document.getElementById('count-counselling').textContent = counselling.length;

        const totalPayment = payments.reduce((s, p) => s + Number(p.amount || p.fee_amount || p.payment_amount || 0), 0);
        document.getElementById('total-payment-amount').textContent = totalPayment;
        document.getElementById('payment-count').textContent = payments.length;
        document.getElementById('count-payments').textContent = payments.length;

        document.getElementById('documents-uploaded').textContent = documents.length;
        document.getElementById('documents-pending').textContent = documents.filter(d => (d.verification_status||'').toLowerCase() !== 'approved').length;

        // Tab counts
        document.getElementById('count-enquiries').textContent = enquiries.length;
        document.getElementById('count-documents').textContent = applications.length;
        document.getElementById('count-students').textContent = students.length;
        document.getElementById('count-admissions').textContent = admissions.length;
        document.getElementById('count-doc-items').textContent = documents.length;
        document.getElementById('count-flow-summary').textContent = students.length;

        // Render tables
        renderTableData('enquiries', enquiries.slice(0, 200));
        renderTableData('applications', applications.slice(0, 200));
        renderTableData('students', students.slice(0, 200));
        renderTableData('admissions', admissions.slice(0, 200));
        renderTableData('counselling', counselling.slice(0, 200));
        renderTableData('payments', payments.slice(0, 200));
        renderTableData('documents', documents.slice(0, 200));

        // Build flow summary rows by joining available datasets (best-effort)
        const flowRows = students.map(s => {
            const unique = s.unique_id || s.uniq_id || s.student_unique || s.id || '';
            const enq = enquiries.find(e => e.student_id == s.id || e.unique_id == unique) || {};
            const app = applications.find(a => a.student_id == s.id || a.unique_id == unique) || {};
            const docs = documents.filter(d => d.student_id == s.id || d.unique_id == unique);
            const coun = counselling.find(c => c.student_id == s.id || c.unique_id == unique) || {};
            const pay = payments.find(p => p.student_id == s.id || p.unique_id == unique) || {};
            return {
                student_name: s.first_name ? `${s.first_name} ${s.last_name || ''}`.trim() : s.student_name || s.name || '',
                unique_id: unique,
                enquiry_status: enq.status || (enq.enquiry_status) || 'N/A',
                enquiry_date: enq.created_at || enq.created_at || null,
                allotted_dept: coun.allotted_department_name || coun.allotted_dept || coun.allotted_department_id || coun.allotted_dept_id || 'N/A',
                preferred_dept: app.preferred_dept || app.preferred_department || 'N/A',
                branch_status: coun.quota_type || coun.quota || 'N/A',
                documents_status: docs.length === 0 ? 'None' : docs.every(d => (d.verification_status||'').toLowerCase()==='approved') ? 'All Approved' : 'Partial',
                documents_count: docs.length,
                counselling_date: coun.created_at || null,
                payment_status: pay.payment_status || (pay.amount ? 'PAID' : 'N/A'),
                payment_amount: pay.amount || pay.fee_amount || 0
            };
        });

        renderTableData('flow_summary', flowRows);

        // Re-render tabs that rely on student enrichment to ensure unique_id/phone populate
        renderTableData('enquiries', enquiries.slice(0, 200));
        renderTableData('applications', applications.slice(0, 200));
        renderTableData('counselling', counselling.slice(0, 200));
        renderTableData('payments', payments.slice(0, 200));
        renderTableData('documents', documents.slice(0, 200));

        // expose students in global cache for manual lookup if needed
        window._studentsCache = students;

    } catch (err) {
        console.error('loadDashboardData error', err);
    }
}

function showTab(tabName) {
    const panes = document.querySelectorAll('.tab-pane');
    panes.forEach(p => p.classList.remove('active'));
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => { btn.classList.remove('active', 'text-primary'); btn.classList.add('text-[#111418]', 'dark:text-white'); });
    const pane = document.getElementById(tabName);
    if (pane) pane.classList.add('active');
    // mark clicked button active
    try { event.target.closest('.tab-btn').classList.add('active', 'text-primary'); } catch(e){}
}

function filterFlowSummary() {
    const query = (document.getElementById('search_flow_summary')?.value || '').toLowerCase();
    const rows = document.querySelectorAll('#flow-summary-rows tr');
    rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(query) ? '' : 'none');
}

function filterTableLocal(tabName) {
    const query = (document.getElementById(`search_${tabName}`)?.value || '').toLowerCase();
    const rows = document.querySelectorAll(`#${tabName}-rows tr`);
    if (!rows.length) {
        // fallback: search inside table body
        const fallback = document.querySelectorAll(`#${tabName}_data tbody tr`);
        fallback.forEach(r => r.style.display = r.innerText.toLowerCase().includes(query) ? '' : 'none');
        return;
    }
    rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(query) ? '' : 'none');
}

async function goToPage(tabName, page) {
    const state = paginationState[tabName];
    if (!state) return;
    const rows = await AdminAPI.list(state.tableName, 500).catch(() => []);
    const filtered = rows.filter(r => JSON.stringify(r).toLowerCase().includes((state.searchQuery||'').toLowerCase()));
    renderTableData(tabName, filtered.slice((page-1)*50, page*50));
    renderPagination(tabName, { current_page: page, total_pages: Math.ceil(filtered.length/50), has_prev: page>1, has_next: page < Math.ceil(filtered.length/50) });
    state.currentPage = page;
}

function renderTableData(tabName, data) {
    // prefer tbody id `${tabName}-rows` if present
    const tableBody = document.getElementById(`${tabName}-rows`) || (document.getElementById(`${tabName}_data`)?.querySelector('tbody'));
    if (!tableBody) return;
    if (!data || data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="10" class="border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-8 text-center text-[#617589] dark:text-[#a0aec0]">No records found</td></tr>`;
        return;
    }
    tableBody.innerHTML = data.map(item => renderRow(tabName, item)).join('');
}

function renderRow(tabName, item) {
    const baseClass = 'border border-[#e5e7eb] dark:border-[#2d3748] px-4 py-3 text-sm text-[#111418] dark:text-white';
    switch(tabName) {
        case 'enquiries':
            // enrich from students map if fields missing
            const enrEnq = resolveStudentFields(item);
            return `<tr class="table-row hover:bg-[#f9fafb] dark:hover:bg-[#111827]/50">
                <td class="${baseClass}">${item.id || item.enquiry_id || ''}</td>
                <td class="${baseClass}">${enrEnq.student_name || item.student_name || item.name || ''}</td>
                <td class="${baseClass}">${enrEnq.unique_id || item.unique_id || item.uniq_id || ''}</td>
                <td class="${baseClass}">${item.email || ''}</td>
                <td class="${baseClass}">${item.phone || 'N/A'}</td>
                <td class="${baseClass}"><span class="px-2 py-1 rounded-full text-xs font-bold ${getStatusBadgeClass(item.status || item.enquiry_status || '')}">${(item.status || item.enquiry_status || '').toUpperCase()}</span></td>
                <td class="${baseClass}">${(item.created_at||'').substring(0,10) || 'N/A'}</td>
            </tr>`;
        case 'applications':
            const enrApp = resolveStudentFields(item);
            const appId = item.id || item.application_id || item.app_id || item.appId || '';
            const docsCount = (item.documents && item.documents.length) ? item.documents.length : (item.document_count !== undefined ? item.document_count : (item.documents_count !== undefined ? item.documents_count : 0));
            return `<tr class="table-row hover:bg-[#f9fafb] dark:hover:bg-[#111827]/50">
                <td class="${baseClass}">${appId}</td>
                <td class="${baseClass}">${enrApp.student_name || item.student_name || item.applicant_name || ''}</td>
                <td class="${baseClass}">${enrApp.unique_id || item.unique_id || item.uniq_id || ''}</td>
                <td class="${baseClass}">${docsCount}</td>
                <td class="${baseClass}"><span class="px-2 py-1 rounded-full text-xs font-bold ${getStatusBadgeClass(item.application_status || item.status || '')}">${(item.application_status || item.status || '').toUpperCase()}</span></td>
                <td class="${baseClass}">${(item.created_at||'').substring(0,10) || 'N/A'}</td>
            </tr>`;
        case 'students':
            return `<tr class="table-row hover:bg-[#f9fafb] dark:hover:bg-[#111827]/50">
                <td class="${baseClass}">${item.id || item.student_id || ''}</td>
                <td class="${baseClass}">${item.first_name ? `${item.first_name} ${item.last_name || ''}`.trim() : item.student_name || item.name || ''}</td>
                <td class="${baseClass}">${item.email || ''}</td>
                <td class="${baseClass}">${item.phone || 'N/A'}</td>
                <td class="${baseClass}">${(item.created_at||'').substring(0,10) || 'N/A'}</td>
            </tr>`;
        case 'admissions':
            // resolve student via student_id or via app mapping
            const enrAdm = resolveStudentFields(item);
            const preferredId = item.preferred_dept_id || item.preferred_dept || item.preferred_department || null;
            const optionalRaw = item.optional_dept_ids || item.optional_departments || item.optional_depts || item.optional || null;
            let optionalList = [];
            try { if(optionalRaw) optionalList = Array.isArray(optionalRaw) ? optionalRaw : JSON.parse(optionalRaw); } catch(e) { optionalList = []; }
            const preferredName = (window._deptMap && preferredId) ? (window._deptMap[String(preferredId)] || preferredId) : (item.preferred_dept || 'N/A');
            const optionalNames = (optionalList && optionalList.length) ? optionalList.map(id => (window._deptMap && window._deptMap[String(id)]) || id).join(', ') : 'N/A';
            // allotted dept may be in counselling records
            let allottedDeptId = item.allotted_dept_id || item.allotted_dept || null;
            const appKey = item.app_id || item.appId || item.id || null;
            if(!allottedDeptId && appKey && window._counsellingByApp && window._counsellingByApp[String(appKey)]) allottedDeptId = window._counsellingByApp[String(appKey)].allotted_dept_id || window._counsellingByApp[String(appKey)].allotted_dept || null;
            const allottedName = allottedDeptId ? ((window._deptMap && window._deptMap[String(allottedDeptId)]) || allottedDeptId) : 'N/A';
            const statusText = (item.status || item.admission_status || item.application_status || 'BRANCH_SELECTION_PENDING');
            const assignedAt = item.processed_at || item.assigned_at || item.updated_at || item.created_at || null;
            // If allotted dept exists, mark as done with tick
            let statusCell = `<span class="px-2 py-1 rounded-full text-xs font-bold ${getStatusBadgeClass(statusText)}">${(statusText||'').toUpperCase()}</span>`;
            if (allottedDeptId) {
                statusCell = `<span class="px-2 py-1 rounded-full text-xs font-bold bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">✔ Done</span>`;
            }
            return `<tr class="table-row hover:bg-[#f9fafb] dark:hover:bg-[#111827]/50">
                <td class="${baseClass}">${enrAdm.student_name || ''}</td>
                <td class="${baseClass}">${enrAdm.unique_id || ''}</td>
                <td class="${baseClass}">${preferredName}</td>
                <td class="${baseClass}">${optionalNames}</td>
                <td class="${baseClass}">${allottedName}</td>
                <td class="${baseClass}">${statusCell}</td>
                <td class="${baseClass}">${assignedAt ? String(assignedAt).substring(0,10) : 'N/A'}</td>
            </tr>`;
        case 'counselling':
            const enrCoun = resolveStudentFields(item);
            // determine allotted dept id then map to name
            let allottedId = item.allotted_dept_id || item.allotted_dept || item.allotted_department_id || null;
            if(!allottedId && item.allotted_department && !isNaN(Number(item.allotted_department))) allottedId = Number(item.allotted_department);
            const allottedDeptName = allottedId && window._deptMap ? (window._deptMap[String(allottedId)] || allottedId) : (item.allotted_department_name || item.allotted_department || 'N/A');
            const quotaText = item.quota_type || item.quota || 'N/A';
            return `<tr class="table-row hover:bg-[#f9fafb] dark:hover:bg-[#111827]/50">
                <td class="${baseClass}">${item.counselling_id || item.id || ''}</td>
                <td class="${baseClass}">${enrCoun.student_name || ''}</td>
                <td class="${baseClass}">${enrCoun.unique_id || ''}</td>
                <td class="${baseClass}">${allottedDeptName}</td>
                <td class="${baseClass}">${quotaText}</td>
            </tr>`;
        case 'payments':
            const enrPay = resolveStudentFields(item);
            return `<tr class="table-row hover:bg-[#f9fafb] dark:hover:bg-[#111827]/50">
                <td class="${baseClass}">${item.id || item.payment_id || ''}</td>
                <td class="${baseClass}">${item.application_id || item.app_id || 'N/A'}</td>
                <td class="${baseClass}">${enrPay.student_name || item.student_name || ''}</td>
                <td class="${baseClass}">${enrPay.unique_id || item.unique_id || item.uniq_id || ''}</td>
                <td class="${baseClass}">${item.bill_no || item.transaction_id || ''}</td>
                <td class="${baseClass}">${item.mode_of_payment || item.mode || 'N/A'}</td>
                <td class="${baseClass}">${item.amount || item.fee_amount || 0}</td>
                <td class="${baseClass}">${(item.created_at||'').substring(0,10) || 'N/A'}</td>
            </tr>`;
        case 'documents':
            const enrDoc = resolveStudentFields(item);
            const docUrl = item.document_url || item.file_url || item.public_url || item.documentUrl || '';
            const appIdCell = item.app_id || item.application_id || item.appId || 'N/A';
            return `<tr class="table-row hover:bg-[#f9fafb] dark:hover:bg-[#111827]/50">
                <td class="${baseClass}">${item.id || item.document_id || ''}</td>
                <td class="${baseClass}">${enrDoc.student_name || item.student_name || ''}</td>
                <td class="${baseClass}">${enrDoc.unique_id || item.unique_id || item.uniq_id || ''}</td>
                <td class="${baseClass}">${appIdCell}</td>
                <td class="${baseClass}">${item.document_type || ''}</td>
                <td class="${baseClass}">${docUrl ? `<a href="${docUrl}" target="_blank" class="px-3 py-1 bg-blue-600 text-white rounded-lg text-xs font-bold">View</a>` : '<span class="text-xs text-[#617589]">No file</span>'}</td>
                <td class="${baseClass}">${(item.created_at||'').substring(0,10) || 'N/A'}</td>
            </tr>`;
        case 'flow_summary':
            return `<tr class="table-row hover:bg-[#f9fafb] dark:hover:bg-[#111827]/50">
                <td class="${baseClass}">${item.student_name || ''}</td>
                <td class="${baseClass}">${item.unique_id || ''}</td>
                <td class="${baseClass}"><div class="flex flex-col"><span class="font-semibold">${item.enquiry_status || ''}</span><span class="text-xs text-[#617589]">${item.enquiry_date ? item.enquiry_date.substring(0,10) : 'N/A'}</span></div></td>
                <td class="${baseClass}"><div class="flex flex-col"><span class="font-semibold">${item.allotted_dept || ''}</span><span class="text-xs text-[#617589]">Preferred: ${item.preferred_dept || 'N/A'}</span><span class="text-xs text-[#617589]">Status: ${item.branch_status || 'N/A'}</span></div></td>
                <td class="${baseClass}"><div class="flex flex-col"><span class="font-semibold">${item.documents_status || ''}</span><span class="text-xs text-[#617589]">${item.documents_count || 0} file(s)</span></div></td>
                <td class="${baseClass}">${item.counselling_date ? item.counselling_date.substring(0,10) : 'N/A'}</td>
                <td class="${baseClass}"><div class="flex flex-col"><span class="font-semibold">${item.payment_status || ''}</span><span class="text-xs text-[#617589]">₹${item.payment_amount || 0}</span></div></td>
            </tr>`;
        default:
            return '';
    }
}

function getStatusBadgeClass(status) {
    status = (status || '').toLowerCase();
    if (status === 'open' || status === 'pending') return 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200';
    if (status === 'converted' || status === 'submitted' || status === 'approved' || status === 'completed' || status === 'paid') return 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';
    if (status === 'rejected' || status === 'failed') return 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200';
    return 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200';
}

function resolveStudentFields(item) {
    // Prefer values on the item, otherwise lookup in students maps by student_id or unique id
    let name = item.student_name || item.name || item.applicant_name || '';
    let uniq = item.unique_id || item.uniq_id || item.uniq || '';

    // try by student_id — always attempt to enrich unique id and phone from students map
    const sid = item.student_id || item.student || item.s_id || null;
    if (sid) {
        const s = studentsMapById[String(sid)];
        if (s) {
            if ((!name || name === '') ) {
                name = s.full_name || (s.first_name ? `${s.first_name} ${s.last_name || ''}`.trim() : s.student_name || s.name || '');
            }
            if (!uniq || uniq === '') uniq = s.unique_id || s.uniq_id || s.id || '';
            if (!item.phone) item.phone = s.phone || s.whatsapp_number || s.father_phone || s.mother_phone || '';
        }
    }

    // If still not resolved, try resolving via application -> student mapping (useful for documents rows)
    if ((!name || name === '' || !uniq || uniq === '') && item.app_id && window._applicationsMap) {
        const app = window._applicationsMap[String(item.app_id)];
        if (app && (app.student_id || app.student)) {
            const s = studentsMapById[String(app.student_id || app.student)];
            if (s) {
                if ((!name || name === '')) name = s.full_name || (s.first_name ? `${s.first_name} ${s.last_name || ''}`.trim() : s.student_name || s.name || '');
                if (!uniq || uniq === '') uniq = s.unique_id || s.uniq_id || s.id || '';
                if (!item.phone) item.phone = s.phone || s.whatsapp_number || '';
            }
        }
    }

    // try by unique id
    if ((!name || name === '') && uniq) {
        const s = studentsMapByUnique[String(uniq)];
        if (s) {
            name = s.first_name ? `${s.first_name} ${s.last_name || ''}`.trim() : s.student_name || s.name || '';
            if (!uniq) uniq = s.unique_id || s.uniq_id || '';
            if (!item.phone) item.phone = s.phone || s.whatsapp_number || s.father_phone || s.mother_phone || '';
        }
    }

    // last-resort: if item has id that matches student id
    if ((!name || name === '') && item.id) {
        const s = studentsMapById[String(item.id)];
        if (s) name = s.first_name ? `${s.first_name} ${s.last_name || ''}`.trim() : s.student_name || s.name || '';
    }

    // try by email using global email map
    if ((!name || name === '') && item.email && window._studentsMapByEmail) {
        const s = window._studentsMapByEmail[String(item.email).toLowerCase()];
        if (s) {
            name = s.full_name || (s.first_name ? `${s.first_name} ${s.last_name || ''}`.trim() : s.student_name || s.name || '');
            if (!uniq) uniq = s.unique_id || s.uniq_id || '';
            if (!item.phone) item.phone = s.phone || s.whatsapp_number || '';
        }
    }

    return { student_name: name, unique_id: uniq };
}

function renderPagination(tabName, result) {
    const paginationContainer = document.getElementById(`${tabName}_pagination`);
    if (!paginationContainer) return;
    const {current_page, total_pages, has_prev, has_next} = result;
    if (!total_pages || total_pages <= 1) { paginationContainer.innerHTML = ''; return; }
    let html = '';
    if (has_prev) html += `<button onclick="goToPage('${tabName}', ${current_page - 1})" class="px-3 py-1 border border-primary text-primary rounded hover:bg-primary hover:text-white transition-colors">← Prev</button>`;
    for (let i = Math.max(1, current_page - 2); i <= Math.min(total_pages, current_page + 2); i++) {
        if (i === current_page) html += `<button class="px-3 py-1 bg-primary text-white rounded font-bold">${i}</button>`;
        else html += `<button onclick="goToPage('${tabName}', ${i})" class="px-3 py-1 border border-[#e5e7eb] dark:border-[#2d3748] rounded hover:border-primary transition-colors">${i}</button>`;
    }
    if (has_next) html += `<button onclick="goToPage('${tabName}', ${current_page + 1})" class="px-3 py-1 border border-primary text-primary rounded hover:bg-primary hover:text-white transition-colors">Next →</button>`;
    paginationContainer.innerHTML = html;
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    loadDashboardData();
});
</script>

</body>
</html>
