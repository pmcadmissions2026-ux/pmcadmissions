<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Branch Selection Dashboard - PMC Engineering</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script id="tailwind-config">tailwind.config = { darkMode: "class", theme: { extend: { colors: { "primary": "#137fec", "background-light": "#f6f7f8", "background-dark": "#101922" }, fontFamily: { "display": ["Lexend","sans-serif"] }, borderRadius: {"DEFAULT":"0.25rem","lg":"0.5rem","xl":"0.75rem","full":"9999px"} } } }</script>
  <style>
    body { font-family: 'Lexend', sans-serif; }
    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    .active-nav { background-color: #137fec; color: white !important; }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-white min-h-screen flex flex-col">
<!-- Minimal client-only admin dashboard (Jinja removed). The page relies on client JS and AdminAPI to populate tables. -->
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] px-6 py-3 sticky top-0 z-50">
  <div class="flex items-center gap-4">
    <div class="text-primary"> <!-- Logo -->
      <svg fill="none" height="32" viewbox="0 0 48 48" width="32" xmlns="http://www.w3.org/2000/svg"><path clip-rule="evenodd" d="M12.0799 24L4 19.2479L9.95537 8.75216L18.04 13.4961L18.0446 4H29.9554L29.96 13.4961L38.0446 8.75216L44 19.2479L35.92 24L44 28.7521L38.0446 39.2479L29.96 34.5039L29.9554 44H18.0446L18.04 34.5039L9.95537 39.2479L4 28.7521L12.0799 24Z" fill="currentColor" fill-rule="evenodd"></path></svg>
    </div>
    <h2 class="text-[#111418] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Er. Perumal Manimekalai College of Engineering</h2>
  </div>
  <div class="flex flex-1 justify-end gap-4 items-center">
    <label class="flex flex-col min-w-64 !h-10 max-w-96">
      <div class="flex w-full flex-1 items-stretch rounded-lg h-full bg-[#f0f2f4] dark:bg-[#2d3748]"><div class="text-[#617589] flex items-center justify-center pl-4"><span class="material-symbols-outlined">search</span></div><input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111418] dark:text-white focus:outline-0 focus:ring-0 border-none bg-transparent h-full placeholder:text-[#617589] px-2 text-sm font-normal" placeholder="Search Unique ID or Student Name..."/></div>
    </label>
    <div class="flex gap-2">
      <a href="#" data-route="profile" class="flex items-center justify-center rounded-lg h-10 w-10 bg-[#f0f2f4] dark:bg-[#2d3748] text-[#111418] dark:text-white hover:bg-slate-200 transition-colors"><span class="material-symbols-outlined">settings</span></a>
      <a href="/auth/logout" class="flex items-center justify-center rounded-lg h-10 w-10 bg-[#f0f2f4] dark:bg-[#2d3748] text-[#111418] dark:text-white hover:bg-slate-200 transition-colors"><span class="material-symbols-outlined">logout</span></a>
    </div>
  </div>
</header>
<div class="flex flex-1">
  <aside class="w-64 border-r border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#1a202c] hidden md:flex flex-col p-4 gap-6 sticky top-[65px] h-[calc(100vh-65px)]">
    <div class="flex items-center gap-3 px-3 py-4"><div class="bg-primary/10 text-primary p-2 rounded-lg"><span class="material-symbols-outlined">shield_person</span></div><div class="flex flex-col"><h1 class="text-[#111418] dark:text-white text-sm font-bold leading-none">Admin Portal</h1><p class="text-[#617589] text-xs font-normal">Management Dashboard</p></div></div>
    <nav id="sidebar-nav" class="flex flex-col gap-2">
      <a href="#" data-route="enquiries" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#111418] dark:text-white hover:bg-[#f0f2f4] dark:hover:bg-[#2d3748] cursor-pointer"><span class="material-symbols-outlined">mail</span><p class="text-sm font-medium">Enquiries</p></a>
      <a href="/admin/admin-branch-management" class="flex items-center gap-3 px-3 py-2.5 rounded-lg active-nav cursor-pointer"><span class="material-symbols-outlined">account_tree</span><p class="text-sm font-medium">Branch Assignment</p></a>
      <a href="#" data-route="counselling_list" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#111418] dark:text-white hover:bg-[#f0f2f4] dark:hover:bg-[#2d3748] cursor-pointer"><span class="material-symbols-outlined">how_to_vote</span><p class="text-sm font-medium">Counselling</p></a>
      <a href="#" data-route="payments_list" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#111418] dark:text-white hover:bg-[#f0f2f4] dark:hover:bg-[#2d3748] cursor-pointer"><span class="material-symbols-outlined">payments</span><p class="text-sm font-medium">Payments</p></a>
      <a href="/templates/admin/document_upload_step1.html" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#137fec] hover:bg-blue-50 cursor-pointer"><span class="material-symbols-outlined">upload_file</span><p class="text-sm font-medium">Document Upload</p></a>
    </nav>
    <div class="mt-auto pt-4 border-t border-[#e5e7eb] dark:border-[#2d3748]"><p class="text-[10px] uppercase tracking-wider text-[#617589] font-bold px-3">System Status</p><div class="flex items-center gap-2 px-3 py-2"><div class="size-2 rounded-full bg-green-500"></div><span class="text-xs text-[#617589]">Admission Server Live</span></div></div>
  </aside>

  <main class="flex-1 overflow-y-auto">
    <div class="max-w-[1200px] mx-auto p-6 flex flex-col gap-6">
      <div class="bg-white dark:bg-[#1a202c] border rounded p-4">
        <div class="flex items-center justify-between">
          <div><p class="text-sm text-[#617589]">Logged in as</p><p id="debug-user-email" class="font-bold">unknown</p></div>
          <div class="flex items-center gap-2"><button id="dbg-check-modules" class="px-3 py-2 bg-primary text-white rounded">Check Assigned Modules</button><button id="dbg-show-keys" class="px-3 py-2 border rounded">Show Keys</button></div>
        </div>
        <div id="dbg-output" class="mt-3 text-xs font-mono text-[#111418] dark:text-white whitespace-pre-wrap"></div>
      </div>

      <!-- Assigned modules wrapper (client will populate) -->
      <div id="assigned-modules-wrapper" data-user-email="" class="bg-white dark:bg-[#1a202c] rounded-lg border border-[#e5e7eb] dark:border-[#2d3748] overflow-hidden p-6">
        <div class="flex items-center gap-3 mb-4"><div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-lg"><span class="material-symbols-outlined text-blue-600 dark:text-blue-400">dashboard</span></div><div><h2 class="text-2xl font-bold text-[#111418] dark:text-white">Your Assigned Modules</h2><p class="text-sm text-[#617589] dark:text-[#a0aec0]">Access only the modules assigned to you</p></div></div>
        <div id="no-modules-placeholder" class="text-center py-12"><span class="material-symbols-outlined text-6xl text-[#e5e7eb] dark:text-[#2d3748] mx-auto block mb-4">lock</span><h3 class="text-lg font-bold text-[#111418] dark:text-white mb-2">No Modules Assigned</h3><p class="text-[#617589] dark:text-[#a0aec0]">You do not have any modules assigned yet.</p></div>
      </div>

      <!-- Branch Management heading -->
      <div id="branch-management" class="flex flex-wrap justify-between items-end gap-3"><div class="flex min-w-72 flex-col gap-1"><p class="text-[#111418] dark:text-white text-3xl font-black leading-tight tracking-[-0.033em]">Admin Branch Management</p><p class="text-[#617589] dark:text-[#a0aec0] text-base font-normal leading-normal">Manage and assign departments to enquired students.</p></div></div>
      <!-- Accepted table (new) -->
      <div class="flex flex-col bg-white dark:bg-[#1a202c] rounded-xl border border-[#e5e7eb] dark:border-[#2d3748] overflow-hidden mt-6">
        <div class="flex items-center justify-between px-6 py-5 border-b border-[#e5e7eb] dark:border-[#2d3748]">
          <h2 class="text-[#111418] dark:text-white text-xl font-bold leading-tight">Accepted Students</h2>
          <button class="text-primary text-sm font-bold flex items-center gap-1 hover:underline"><span class="material-symbols-outlined text-sm">download</span> Export List</button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="bg-[#f8fafc] dark:bg-[#2d3748] border-b border-[#e5e7eb] dark:border-[#2d3748]">
                <th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Student Name</th>
                <th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Unique ID</th>
                <th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Cut-off</th>
                <th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Community</th>
                <th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="accepted-tbody" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"><tr><td colspan="5" class="px-6 py-12 text-center text-slate-500"><span class="material-symbols-outlined text-4xl mb-2">check_circle</span><p class="text-sm font-medium">No accepted students loaded</p></td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Tables (empty tbody; client injector will fill) -->
      <div class="flex flex-col bg-white dark:bg-[#1a202c] rounded-xl border border-[#e5e7eb] dark:border-[#2d3748] overflow-hidden">
        <div class="flex items-center justify-between px-6 py-5 border-b border-[#e5e7eb] dark:border-[#2d3748]">
          <h2 class="text-[#111418] dark:text-white text-xl font-bold leading-tight">Pending Branch Selection</h2>
          <button class="text-primary text-sm font-bold flex items-center gap-1 hover:underline"><span class="material-symbols-outlined text-sm">download</span> Export List</button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="bg-[#f8fafc] dark:bg-[#2d3748] border-b border-[#e5e7eb] dark:border-[#2d3748]">
                <th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Student Name</th>
                <th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Unique ID</th>
                <th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Cut-off</th>
                <th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider">Community</th>
                <th class="px-6 py-4 text-sm font-bold text-[#617589] dark:text-[#a0aec0] uppercase tracking-wider text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="pending-tbody" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"><tr><td colspan="5" class="px-6 py-12 text-center text-slate-500"><span class="material-symbols-outlined text-4xl mb-2">hourglass_empty</span><p class="text-sm font-medium">No pending students loaded</p></td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Assigned / Accepted placeholders -->
      <div id="assigned-accepted-section" class="mt-8 space-y-6">
        <div id="accepted-by-you" class="hidden"></div>
        <div class="rounded-xl shadow-sm border border-[#f0f2f4] dark:border-gray-800 overflow-hidden bg-white dark:bg-[#1a202c]">
          <div class="px-6 py-4 border-b border-[#e5e7eb] dark:border-[#2d3748] bg-white dark:bg-[#0f1419]"><div class="flex items-center justify-between"><h2 class="text-[#111418] dark:text-white text-xl font-bold leading-tight flex items-center gap-3"><span class="material-symbols-outlined text-primary text-2xl">check_circle</span>Assigned Branches</h2><span id="assigned-count" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">0 Assigned</span></div></div>
          <div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50 dark:bg-gray-800"><tr class="border-b border-[#e5e7eb] dark:border-[#2d3748]"><th class="px-6 py-3 text-left text-xs font-bold text-[#111418] dark:text-white uppercase">App #</th><th class="px-6 py-3 text-left text-xs font-bold text-[#111418] dark:text-white uppercase">Name</th><th class="px-6 py-3 text-left text-xs font-bold text-[#111418] dark:text-white uppercase">Unique ID</th><th class="px-6 py-3 text-left text-xs font-bold text-[#111418] dark:text-white uppercase">Preferred Dept</th><th class="px-6 py-3 text-left text-xs font-bold text-[#111418] dark:text-white uppercase">Optional Dept</th><th class="px-6 py-3 text-left text-xs font-bold text-[#111418] dark:text-white uppercase">Allotted Dept</th><th class="px-6 py-3 text-left text-xs font-bold text-[#111418] dark:text-white uppercase">Cutoff</th></tr></thead><tbody id="assigned-tbody" class="divide-y divide-[#e5e7eb] dark:divide-[#2d3748]"><tr><td colspan="7" class="px-6 py-12 text-center text-slate-500">No assigned students loaded</td></tr></tbody></table></div>
        </div>
      </div>

      <div class="bg-primary/5 border border-primary/20 rounded-xl p-4 flex gap-4 mt-8"><div class="text-primary"><span class="material-symbols-outlined">info</span></div><div><p class="text-sm font-semibold text-[#111418] dark:text-white">Administration Tip</p><p class="text-xs text-[#617589] mt-1">Students with high cut-off marks are highlighted for immediate counseling.</p></div></div>
    </div>
  </main>
</div>

<!-- Include AdminAPI client (must exist in static/js/admin_api.js) -->
<script id="admin-api-script" src="/static/js/admin_api.js"></script>

<script>
// Lightweight client injector: populate debug email and wire AdminAPI-populated data to tables.
function safeJsonParse(s){ try{ return JSON.parse(s); }catch(e){ return null; } }
function setText(id, txt){ const el = document.getElementById(id); if(el) el.textContent = txt; }

document.addEventListener('DOMContentLoaded', function(){
  // Populate debug email from sessionStorage or window.__SERVER_DATA
    try{
      let email = '';
      const stored = sessionStorage.getItem('pmc_user');
      if(stored){ try{ const u = JSON.parse(stored); if(u && u.email) email = u.email; }catch(_){} }
      if(!email && window.__SERVER_DATA && window.__SERVER_DATA.current_user && window.__SERVER_DATA.current_user.email) email = window.__SERVER_DATA.current_user.email;
      if(!email && window.ADMIN_USER_EMAIL) email = window.ADMIN_USER_EMAIL;
      if(email) document.getElementById('debug-user-email').textContent = email;
      const wrapper = document.getElementById('assigned-modules-wrapper'); if(wrapper) wrapper.dataset.userEmail = email || '';

      // Load client config then fetch the logged-in user's assigned_modules from public.users
      (function loadAndFetchModules(){
        const script = document.createElement('script');
        script.src = '/config.js';
        script.onload = async function(){
          try{
            const cfg = window.__SUPABASE_CONFIG || window.__SERVER_CONFIG || window.__CONFIG || {};
            const base = (cfg.SUPABASE_URL||window.ADMIN_SUPABASE_URL||'').replace(/\/+$/, '');
            const token = cfg.SUPABASE_KEY || window.ADMIN_SUPABASE_KEY || '';
            if(!base || !token) return;

            // Try to use sessionStorage user id if available
            let userId = null;
            try{ const u = JSON.parse(sessionStorage.getItem('pmc_user')||'null'); if(u && u.user_id) userId = u.user_id; }catch(e){}

            // Fallback: try to lookup by email stored on page
            let emailLookup = document.getElementById('debug-user-email').textContent || '';

            let url = null;
            if(userId) url = `${base}/rest/v1/users?select=*&user_id=eq.${encodeURIComponent(userId)}`;
            else if(emailLookup) url = `${base}/rest/v1/users?select=*&email=eq.${encodeURIComponent(emailLookup)}`;
            if(!url) return;

            const res = await fetch(url, { headers: { 'apikey': token, 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' } });
            if(!res.ok) throw new Error('Fetch failed: '+res.status);
            const arr = await res.json();
            if(!Array.isArray(arr) || arr.length===0) return;
            const user = arr[0];

            // Parse assigned_modules robustly
            let modules = user.assigned_modules;
            let list = [];
            if(Array.isArray(modules)) list = modules;
            else if(typeof modules === 'string'){
              try{ list = JSON.parse(modules); }catch(e){ try{ list = JSON.parse(modules.replace(/^"|"$/g, '')); }catch(e2){ list = []; } }
            }

            // Render into assigned-modules-wrapper
            const wrapperEl = document.getElementById('assigned-modules-wrapper');
            if(!wrapperEl) return;
            const placeholder = document.getElementById('no-modules-placeholder');
            if(!list || list.length===0){ if(placeholder) placeholder.style.display = 'block'; return; }
            if(placeholder) placeholder.style.display = 'none';

            // Build simple module tiles
            const container = document.createElement('div');
            container.className = 'grid grid-cols-2 md:grid-cols-4 gap-3';
            list.forEach(m => {
              const card = document.createElement('div');
              card.className = 'border rounded p-3 bg-white dark:bg-[#111827]';
              card.innerHTML = `<div class="text-sm font-bold text-[#111418] dark:text-white">${m}</div>`;
              container.appendChild(card);
            });
            // remove existing rendered area if present
            const existing = wrapperEl.querySelector('.modules-rendered'); if(existing) existing.remove();
            const rendered = document.createElement('div'); rendered.className = 'modules-rendered mt-4'; rendered.appendChild(container);
            wrapperEl.appendChild(rendered);

            // Also render the sidebar navigation based on assigned modules
            try{
              const navMap = {
                'dashboard': { label: 'Dashboard', href: '/templates/admin/dashboard.html', icon: 'dashboard' },
                'enquiries': { label: 'Enquiries', href: '/templates/admin/enquiries.html', icon: 'mail' },
                'applications': { label: 'Applications', href: '/templates/admin/document_upload_step1.html', icon: 'receipt_long' },
                'branch_selection': { label: 'Branch Assignment', href: '/templates/admin/branch_selection.html', icon: 'account_tree' },
                'counselling': { label: 'Counselling', href: '/templates/admin/counselling_list.html', icon: 'how_to_vote' },
                'payments': { label: 'Payments', href: '/templates/admin/payments_list.html', icon: 'payments' },
                'documents': { label: 'Documents', href: '/templates/admin/documents_management.html', icon: 'description' },
                'reports': { label: 'Reports', href: '/templates/admin/reports.html', icon: 'insights' },
                'staff': { label: 'Staff', href: '/templates/admin/staff_management.html', icon: 'groups' }
              };

              const sidebar = document.getElementById('sidebar-nav');
              if(sidebar){
                // clear existing links
                sidebar.innerHTML = '';
                // always include Dashboard (if present in modules or as default)
                const allowed = new Set(list.map(String));
                // If 'dashboard' is not explicitly present, still show it for all users
                if(!allowed.has('dashboard')) allowed.add('dashboard');
                // Render in a preferred order
                const order = ['dashboard','enquiries','applications','branch_selection','counselling','payments','documents','reports','staff'];
                order.forEach(key => {
                  if(!allowed.has(key)) return;
                  const spec = navMap[key] || { label: key, href: `/templates/admin/${key}.html`, icon: 'circle' };
                  const a = document.createElement('a');
                  a.href = spec.href;
                  a.className = 'flex items-center gap-3 px-3 py-2.5 rounded-lg text-[#111418] dark:text-white hover:bg-[#f0f2f4] dark:hover:bg-[#2d3748] cursor-pointer';
                  a.setAttribute('data-module', key);
                  a.innerHTML = `<span class="material-symbols-outlined">${spec.icon}</span><p class="text-sm font-medium">${spec.label}</p>`;
                  sidebar.appendChild(a);
                });
              }
            }catch(e){ console.warn('render sidebar', e); }

          }catch(err){ console.warn('loadAndFetchModules error', err); }
        };
        document.head.appendChild(script);
      })();

    }catch(e){ console.warn('init email', e); }

  // When AdminAPI populates window.__SERVER_DATA, render tables
  function renderFromServerData(){
    const data = window.__SERVER_DATA || {};
    try{
      // pending
      const pendingTbody = document.getElementById('pending-tbody');
      if(pendingTbody){ pendingTbody.innerHTML = ''; const list = data.pending || []; if(list.length===0){ pendingTbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-500">No pending students</td></tr>'; } else { list.forEach(s=>{ const cutoff = s.cutoff ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${s.cutoff>=190? 'bg-green-100 text-green-800' : (s.cutoff>=180? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800')}">${Number(s.cutoff).toFixed(2)}</span>` : '<span class="text-xs text-slate-400">Pending</span>'; const row = document.createElement('tr'); row.className='hover:bg-[#f0f2f4] dark:hover:bg-[#2d3748] transition-colors group'; row.innerHTML=`<td class="px-6 py-4"><div class="text-sm font-semibold text-[#111418] dark:text-white">${s.name||''}</div><div class="text-xs text-[#617589]">${s.time_ago||''}</div></td><td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-mono">${s.unique_id||'N/A'}</td><td class="px-6 py-4">${cutoff}</td><td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-medium">${s.community||'General'}</td><td class="px-6 py-4 text-right"><a href="#" data-action="assign_branch" data-student-id="${s.student_id||''}" class="inline-flex items-center gap-2 bg-primary text-white text-xs font-bold py-2 px-4 rounded-lg">Assign Branch</a></td>`; pendingTbody.appendChild(row); }); } }

          // accepted - determine assignment status from admissions table when available
          const acceptedTbody = document.getElementById('accepted-tbody');
          if(acceptedTbody){
            acceptedTbody.innerHTML = '';
            const listA = data.accepted || [];

            // Prefer authoritative admissions array if provided by AdminAPI
            const admissionsArr = Array.isArray(data.admissions) ? data.admissions : (Array.isArray(data.assigned) ? data.assigned : []);
            // Build lookup maps by student id and by unique id (some systems populate either)
            const admissionByStudent = new Map();
            const admissionByUnique = new Map();
            admissionsArr.forEach(a => {
              if(!a) return;
              if(a.student_id) admissionByStudent.set(String(a.student_id), a);
              // check common unique id fields on admission rows
              const uniq = a.unique_id || a.student_unique_id || a.student_uniqueid || a.student_unique || a.student_unique;
              if(uniq) admissionByUnique.set(String(uniq), a);
            });

            if(listA.length===0){
              acceptedTbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-500">No accepted students loaded</td></tr>';
            } else {
              listA.forEach(s=>{
                const cutoff = s.cutoff ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${s.cutoff>=190? 'bg-green-100 text-green-800' : (s.cutoff>=180? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800')}">${Number(s.cutoff).toFixed(2)}</span>` : '<span class="text-xs text-slate-400">-</span>';
                const row = document.createElement('tr');
                row.className='hover:bg-[#f0f2f4] dark:hover:bg-[#2d3748] transition-colors group';

                const studentIdKey = String(s.id || s.student_id || '');
                const studentUniqueKey = String(s.unique_id || s.uniqueId || s.unique || '');
                // Prefer admission by student_id, fallback to matching by unique id
                let admission = admissionByStudent.get(studentIdKey) || null;
                if(!admission && studentUniqueKey){ admission = admissionByUnique.get(studentUniqueKey) || null; }
                // Consider a student Assigned if there is an admission row present
                // (some workflows treat presence in admissions as 'assigned' even before allotment)
                const isAssigned = !!admission;

                let actionHtml = '';
                if(isAssigned){
                  actionHtml = `<button disabled class="inline-flex items-center gap-2 bg-green-600 text-white text-xs font-bold py-2 px-4 rounded-lg"><span class="material-symbols-outlined">check</span>Assigned</button>`;
                } else {
                  actionHtml = `<a href="#" data-action="assign_branch" data-student-id="${s.id||s.student_id||''}" class="inline-flex items-center gap-2 bg-primary text-white text-xs font-bold py-2 px-4 rounded-lg">Assign Branch</a>`;
                }

                row.innerHTML = `<td class="px-6 py-4"><div class="text-sm font-semibold text-[#111418] dark:text-white">${s.full_name||s.name||''}</div><div class="text-xs text-[#617589]">Accepted</div></td><td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-mono">${s.unique_id||'N/A'}</td><td class="px-6 py-4">${cutoff}</td><td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-medium">${s.community||'General'}</td><td class="px-6 py-4 text-right">${actionHtml}</td>`;
                acceptedTbody.appendChild(row);
              });
            }
          }

      // assigned
      const assignedTbody = document.getElementById('assigned-tbody');
      if(assignedTbody){
        assignedTbody.innerHTML = '';
        const list = data.assigned || [];
        setText('assigned-count', (list.length||0) + ' Assigned');
        if(list.length===0){
          assignedTbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-slate-500">No assigned students</td></tr>';
        } else {
          list.forEach(st => {
            const optional = (st.optional_depts||[]).map(d=>`<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400">${d.dept_code||''}</span>`).join('');
            const cutoffLabel = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${st.cutoff>=190? 'bg-green-100 text-green-800' : (st.cutoff>=180? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800')}">${Number(st.cutoff||0).toFixed(2)}</span>`;
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800/40 transition-colors';
            const appCell = st.app_id ? `<a class="text-primary font-mono font-bold" href="/templates/admin/document_upload.html?app_id=${encodeURIComponent(st.app_id)}">#${st.app_id}</a>` : '<span class="text-xs text-slate-400">N/A</span>';
            // Add icon for document upload step
            const docUploadIcon = st.app_id ? `<a href="/templates/admin/document_upload_step1.html?app_id=${encodeURIComponent(st.app_id)}" class="inline-flex items-center gap-1 text-blue-600 hover:underline"><span class="material-symbols-outlined">upload_file</span>Upload Docs</a>` : '';
            row.innerHTML = `<td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-mono font-bold">${appCell}<br/>${docUploadIcon}</td><td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-medium">${st.name||''}</td><td class="px-6 py-4 text-sm text-[#111418] dark:text-white font-mono">${st.unique_id||'N/A'}</td><td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400">${st.preferred_dept_code||''}</span></td><td class="px-6 py-4">${optional||'<span class="text-xs text-[#617589] dark:text-gray-500">-</span>'}</td><td class="px-6 py-4">${st.allotted_dept_code?('<div class="flex items-center gap-2"><span class="material-symbols-outlined text-green-600 text-sm">check</span><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400>'+st.allotted_dept_code+'</span></div>'):'<span class="text-xs text-[#617589] dark:text-gray-500">Pending</span>'}</td><td class="px-6 py-4">${cutoffLabel}</td>`;
            assignedTbody.appendChild(row);
          });
        }
      }

    }catch(e){ console.error('renderFromServerData', e); }
  }

  // If AdminAPI has already populated, render now; otherwise listen for event
  // Also fetch authoritative admissions from the server (no Supabase) and refresh tables.
  async function fetchAdmissionsAndRefresh(){
    const url = '/api/admissions';
    try{
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if(res.ok){
        const arr = await res.json();
        window.__SERVER_DATA = window.__SERVER_DATA || {};
        // store admissions so renderFromServerData can use it to mark assigned students
        window.__SERVER_DATA.admissions = Array.isArray(arr) ? arr : [];
      } else {
        console.warn('fetchAdmissions failed', res.status);
      }
    }catch(err){ console.warn('fetchAdmissions error', err); }
    renderFromServerData();
  }

  if(window.__SERVER_DATA){ renderFromServerData(); fetchAdmissionsAndRefresh(); }
  window.addEventListener('admin_api:populated', function(){ renderFromServerData(); fetchAdmissionsAndRefresh(); });

  // Debug buttons
  const dbgOut = document.getElementById('dbg-output'); document.getElementById('dbg-check-modules').addEventListener('click', async function(){ dbgOut.textContent = ''; try{ if(window.AdminAPI && AdminAPI.get){ dbgOut.textContent += 'Using AdminAPI.get\n'; const users = await AdminAPI.get('users', { select: '*', email: `eq.${document.getElementById('debug-user-email').textContent}` }); dbgOut.textContent += JSON.stringify(users, null, 2); } else { dbgOut.textContent += 'AdminAPI not available'; } }catch(e){ dbgOut.textContent += 'Error: ' + (e.message||e); }});
  document.getElementById('dbg-show-keys').addEventListener('click', function(){ dbgOut.textContent = ''; dbgOut.textContent += 'ADMIN_SUPABASE_URL=' + (window.ADMIN_SUPABASE_URL||'<none>') + '\n'; dbgOut.textContent += 'ADMIN_SUPABASE_KEY present=' + (!!window.ADMIN_SUPABASE_KEY) + '\n'; dbgOut.textContent += 'AdminAPI present=' + (!!window.AdminAPI) + '\n'; });

  // Delegate Assign Branch clicks: redirect to assign page with student_id
  document.body.addEventListener('click', function(e){
    const a = e.target.closest && e.target.closest('[data-action="assign_branch"]');
    if(!a) return;
    e.preventDefault();
    const studentId = a.dataset.studentId || a.getAttribute('data-student-id');
    if(!studentId){ alert('Student id missing'); return; }
    // navigate to the client assign page with student_id
    location.href = '/templates/admin/assign_branch.html?student_id=' + encodeURIComponent(studentId);
  });
});
</script>

</body>
</html>